<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Loan Portfolio — Pretty (Option A)</title>

  <style>
    :root{
      --muted:#64748b;
      --card:#ffffff;
      --brand:#0ea5e9;
      --accent:#7c3aed;
      --surface:#f8fafc;
    }

    html,body{
      height:100%;
      margin:0;
      font-family:Inter, system-ui, -apple-system, "Segoe UI", Roboto, Arial;
      color:#0f172a;
      -webkit-font-smoothing:antialiased;
    }

    body{
      background: linear-gradient(180deg,#f1f5f9 0%, #f8fafc 100%);
    }

    .app{
      max-width:1200px;
      margin:20px auto;
      padding:16px;
    }

    header{
      display:flex;
      flex-direction:column;
      gap:8px;
      margin-bottom:12px;
    }

    .header-top{
      display:flex;
      align-items:center;
      justify-content:space-between;
    }

    h1{ font-size:20px; margin:0; }
    p.lead{ margin:0; color:var(--muted); font-size:13px; }
    .current-date{ font-size:13px; color:var(--muted); margin-top:4px; }

    /* KPI row */
    .kpis{
      display:grid;
      grid-template-columns:repeat(4,1fr);
      gap:12px;
      margin:14px 0 18px;
    }
    .kpi{
      background:var(--card);
      padding:12px;
      border-radius:10px;
      box-shadow:0 6px 18px rgba(16,24,40,0.04);
      border:1px solid rgba(15,23,42,0.04);
      cursor:pointer;
      transition: transform .18s, box-shadow .18s;
    }
    .kpi:hover{ transform:translateY(-6px); box-shadow:0 12px 30px rgba(15,23,42,0.08); }
    .kpi h3{ margin:0; font-size:12px; color:var(--muted) }
    .kpi p{ margin:8px 0 0; font-size:18px; font-weight:700 }

    /* Grid of tiles */
    .grid{
      display:grid;
      grid-template-columns:repeat(2,1fr);
      gap:12px;
      height:calc(100vh - 300px);
      overflow:auto;
      padding-right:6px;
    }
    @media(max-width:900px){
      .grid{ grid-template-columns:1fr; height:auto }
      .kpis{ grid-template-columns:repeat(2,1fr) }
    }

    .tile{
      display:flex;
      align-items:center;
      justify-content:space-between;
      padding:10px 12px;
      border-radius:12px;
      background:var(--card);
      min-height:110px;
      cursor:pointer;
      overflow:hidden;
      transition: transform .18s ease, box-shadow .18s ease;
    }
    .tile:hover{ transform:translateY(-6px); box-shadow:0 12px 30px rgba(15,23,42,0.08) }

    .tile-left{ flex:1; padding-right:10px }
    .loan-name{ font-weight:700; font-size:14px }
    .loan-sub{ font-size:12px; color:var(--muted); margin-top:6px }
    .loan-meta{ display:flex; gap:8px; font-size:12px; color:var(--muted); margin-top:8px }

    .chart-wrap{ width:170px; flex-shrink:0; display:flex; flex-direction:column; align-items:flex-end }
    .mini-label{ font-size:12px; color:var(--muted); margin-bottom:6px }
    svg.sparkline{ width:170px; height:48px; display:block }

    /* Drawer */
    .drawer{
      position:fixed;
      right:0;
      top:0;
      height:100vh;
      width:560px;
      background:var(--card);
      box-shadow:-28px 0 80px rgba(2,6,23,0.14);
      transform:translateX(110%);
      transition:transform .28s cubic-bezier(.2,.9,.3,1);
      z-index:90;
      overflow:auto;
      padding:20px;
    }
    .drawer.open{ transform:translateX(0) }

    .drawer-head{ display:flex; align-items:start; justify-content:space-between; gap:8px }
    .close-btn{
      background:#f1f5f9;
      border:none;
      padding:8px;
      border-radius:8px;
      cursor:pointer;
    }
    .drawer h2{ margin:0 0 6px; font-size:20px }
    .muted{ color:var(--muted); font-size:13px; margin-bottom:10px }

    .drawer-chart{
      height:220px;
      background:linear-gradient(180deg,#ffffff,#fcfeff);
      border-radius:8px;
      border:1px solid rgba(15,23,42,0.03);
      display:flex;
      align-items:center;
      justify-content:center;
      margin-bottom:8px;
      position:relative;
      padding:8px;
    }

    .legend { display:flex; gap:10px; font-size:12px; align-items:center; margin-top:6px; }
    .legend .item { display:flex; gap:6px; align-items:center; }
    .legend .sw { width:12px; height:8px; border-radius:2px; display:inline-block; }

    .amort-wrap{
      border:1px solid rgba(15,23,42,0.04);
      border-radius:8px;
      padding:8px;
      max-height:40vh;
      overflow:auto;
    }

    table{ width:100%; border-collapse:collapse; font-size:13px }
    thead th{
      position:sticky; top:0; background:var(--card);
      padding:8px; text-align:left; color:var(--muted); font-weight:700;
    }
    td{ padding:8px; border-bottom:1px dashed rgba(15,23,42,0.04); text-align:right }
    td:first-child, th:first-child{ text-align:left }

    .actions{ display:flex; gap:8px; margin-top:12px }
    .btn{ padding:8px 10px; border-radius:8px; border:1px solid rgba(15,23,42,0.06); background:transparent; cursor:pointer; font-weight:600 }
    .btn.primary{ background:linear-gradient(90deg,var(--brand),var(--accent)); color:white; border:none }

    .tooltip{
      position:fixed;
      pointer-events:none;
      background:#0f172a;
      color:white;
      padding:6px 8px;
      border-radius:6px;
      font-size:12px;
      transform:translate(-50%,-120%);
      box-shadow:0 6px 18px rgba(2,6,23,0.2);
      display:none;
      z-index:9999;
      line-height:1.12;
    }

    .small { font-size:12px; color:var(--muted) }
  </style>
</head>

<body>
  <div class="app" role="main">
    <header>
      <div class="header-top">
        <div>
          <h1>Loan Portfolio</h1>
          <p class="lead">Compact tiles • mini-charts show cumulative principal & interest • KPI drawers & Loan drawers on the right</p>
        </div>
        <div style="display:flex;gap:10px;align-items:center">
          <div style="font-size:13px;color:var(--muted)">Name: <strong style="color:var(--brand)">Jeff Customer</strong></div>
        </div>
      </div>

      <div class="current-date">Current Month: <strong id="currentMonthLabel">18</strong> (months since first purchase)</div>
    
<label class="theme-toggle">
  <input type="checkbox" id="themeSwitch">
  <span class="slider"></span>
</label>
</header>


    <section class="kpis" id="kpis"></section>

    <section class="grid" id="loanGrid" aria-live="polite"></section>
  </div>

  <!-- Right drawer -->
  <aside id="drawer" class="drawer" aria-hidden="true">
    <div class="drawer-head">
      <div>
        <h2 id="drawerTitle">Drawer</h2>
        <div class="muted" id="drawerSub">details</div>
      </div>

      <div style="display:flex;gap:8px;align-items:center">
        <button class="btn" id="downloadCsvBtn">Download CSV</button>
        <button class="close-btn" id="closeBtn" aria-label="Close drawer">✕</button>
      </div>
    </div>

    <div id="drawerBody">
      <div class="drawer-chart" id="drawerChartArea"></div>
      <div class="legend" id="drawerLegend" style="display:none"></div>

      <div style="display:flex;gap:10px;margin-bottom:8px">
        <div style="flex:1;background:#f8fafc;padding:10px;border-radius:8px">
          <div style="font-size:12px;color:var(--muted)" id="drawerPrimaryTitle">Purchase Price</div>
          <div id="drawerPrimary" style="font-weight:800;font-size:18px"></div>
        </div>
        <div style="width:120px;background:#f8fafc;padding:10px;border-radius:8px">
          <div style="font-size:12px;color:var(--muted)" id="drawerSecondaryTitle">Rate</div>
          <div id="drawerSecondary" style="font-weight:800;font-size:16px"></div>
        </div>
      </div>

      <div id="drawerExtra"></div>

      <div id="drawerAmortContainer">
        <h3 style="margin-top:8px">Amortization</h3>
        <div class="amort-wrap" id="amortWrap">
          <table>
            <thead>
              <tr>
                <th>Month</th><th>Payment</th><th>Principal</th><th>Interest</th><th>Balance</th>
              </tr>
            </thead>
            <tbody id="amortBody"></tbody>
          </table>
        </div>
      </div>
    </div>

    <div class="actions" style="padding-top:10px">
      <button class="btn" id="printBtn">Print</button>
      <button class="btn primary" id="copyCsvBtn">Copy CSV</button>
    </div>
  </aside>

  <div id="tooltip" class="tooltip" role="status" aria-live="polite"></div>

  <script>
    /* ============================
       Settings & Current Month
       ============================ */
    const CURRENT_MONTH = 18;
    document.getElementById('currentMonthLabel').textContent = CURRENT_MONTH;

    /* ============================
       Loan data (dates spread across ~6 months)
       ============================ */
    const loans = [
      { id:1, purchaseDate:'2025-01-15', purchasePrice:10000, termYears:10, graceYears:4.5, nominalRate:0.08 },
      { id:2, purchaseDate:'2025-02-01', purchasePrice:7500, termYears:8, graceYears:2, nominalRate:0.075 },
      { id:3, purchaseDate:'2025-02-20', purchasePrice:12000, termYears:12, graceYears:3, nominalRate:0.0825 },
      { id:4, purchaseDate:'2025-03-10', purchasePrice:6000, termYears:9, graceYears:1.5, nominalRate:0.095 },
      { id:5, purchaseDate:'2025-03-30', purchasePrice:5000, termYears:10, graceYears:1, nominalRate:0.09 },
      { id:6, purchaseDate:'2025-04-15', purchasePrice:7500, termYears:5, graceYears:0, nominalRate:0.073 },
      { id:7, purchaseDate:'2025-04-30', purchasePrice:10000, termYears:8, graceYears:0, nominalRate:0.09 },
      { id:8, purchaseDate:'2025-05-20', purchasePrice:5000, termYears:9, graceYears:0.5, nominalRate:0.11 },
      { id:9, purchaseDate:'2025-06-10', purchasePrice:10000, termYears:7, graceYears:0.25, nominalRate:0.10 },
      { id:10,purchaseDate:'2025-06-30', purchasePrice:8000, termYears:3, graceYears:0, nominalRate:0.06 }
    ];

    /* ============================
       Amortization (grace interest capitalized)
       ============================ */
    function calcAmort(principal, annualRate, termYears, graceYears) {
      const monthlyRate = annualRate / 12;
      const totalMonths = Math.round(termYears * 12);
      const graceMonths = Math.round(graceYears * 12);
      const repayMonths = Math.max(1, totalMonths - graceMonths);

      let balance = principal;
      const schedule = [];

      // Grace months — interest accrues and capitalizes (payment = 0)
      for (let m = 1; m <= graceMonths; m++) {
        const interest = +(balance * monthlyRate).toFixed(2);
        balance = +(balance + interest).toFixed(2); // capitalize
        schedule.push({ monthIndex: m, payment: 0, principalPaid: 0, interest, balance });
      }

      // Payment computed on capitalized balance after grace
      const payment = monthlyRate === 0
        ? +(balance / repayMonths).toFixed(2)
        : +((balance * monthlyRate) / (1 - Math.pow(1 + monthlyRate, -repayMonths))).toFixed(2);

      // Repayment months
      for (let m = 1; m <= repayMonths; m++) {
        const interest = +(balance * monthlyRate).toFixed(2);
        const principalPaid = +Math.min(balance, +(payment - interest).toFixed(2));
        balance = +(Math.max(0, balance - principalPaid).toFixed(2));
        schedule.push({ monthIndex: graceMonths + m, payment: +payment.toFixed(2), principalPaid, interest, balance });
      }

      return { payment, schedule };
    }

    /* ============================
       Build loans with amort + cumulative metrics + mini points
       ============================ */
    const loansWithAmort = loans.map(l => {
      const amort = calcAmort(l.purchasePrice, l.nominalRate, l.termYears, l.graceYears);

      let cumP = 0, cumI = 0, cumTotal = 0;
      const cumSchedule = amort.schedule.map(r => {
        cumP = +(cumP + r.principalPaid).toFixed(2);
        cumI = +(cumI + r.interest).toFixed(2);
        cumTotal = +(cumTotal + r.payment).toFixed(2);
        return { ...r, cumPrincipal: cumP, cumInterest: cumI, cumTotal };
      });

      // mini points downsample to max 24 for speed
      const miniPts = cumSchedule.slice(0, Math.min(24, cumSchedule.length))
        .map(s => ({ x: s.monthIndex, cumP: s.cumPrincipal, cumI: s.cumInterest }));

      return { ...l, amort, cumSchedule, miniPts };
    });

    /* ============================
       KPIs
       ============================ */
    function computeKPIs(list) {
      const total = list.reduce((s, l) => s + l.purchasePrice, 0);
      const weightedRate = list.reduce((s, l) => s + l.nominalRate * l.purchasePrice, 0) / Math.max(1, total);
      const weightedDuration = list.reduce((s, l) => s + (l.termYears * 12) * l.purchasePrice, 0) / Math.max(1, total);
      // monthly income ≈ sum of first scheduled payment across loans
      const monthlyIncome = list.reduce((s, l) => s + (l.amort.schedule.length ? l.amort.schedule[0].payment : 0), 0);
      return { total, weightedRate: weightedRate * 100, weightedDuration, monthlyIncome };
    }

    const kpis = computeKPIs(loansWithAmort);

    /* ============================
       Small helper — create SVG path from points
       ============================ */
    function buildPathFromPoints(points, w, h, pad = 6) {
      if (!points.length) return '';

      const ys = points.map(p => p.y);
      const minY = Math.min(...ys);
      const maxY = Math.max(...ys);
      const range = Math.max(1, maxY - minY);
      const stepX = (w - pad * 2) / Math.max(1, points.length - 1);

      let d = '';
      points.forEach((p, i) => {
        const x = pad + i * stepX;
        const y = pad + (h - pad * 2) - ((p.y - minY) / range) * (h - pad * 2);
        d += (i === 0 ? `M ${x} ${y}` : ` L ${x} ${y}`);
      });

      return d;
    }

    /* ============================
       Render KPI tiles
       ============================ */
    const kpisEl = document.getElementById('kpis');
    kpisEl.innerHTML = `
      <div class="kpi" data-kpi="distribution"><h3>Total Loans</h3><p>${loansWithAmort.length}</p></div>
      <div class="kpi" data-kpi="tpv"><h3>Total Portfolio Value</h3><p id="tpvTile">$0</p></div>
      <div class="kpi" data-kpi="rates"><h3>Avg Rate</h3><p>${kpis.weightedRate.toFixed(2)}%</p></div>
      <div class="kpi" data-kpi="payments"><h3>Monthly Income</h3><p>$${kpis.monthlyIncome.toFixed(2)}</p></div>
    `;

    /* ============================
       TPV (Total Portfolio Value) series
       Definition:
         TPV_loan(m) = initialPurchase + accruedInterestDuringGrace_upTo_m + cumulativePaymentsUpTo_m
       ============================ */
    function tpvSeries(loansList) {
      const maxMonths = Math.max(...loansList.map(l => l.amort.schedule.length));
      const series = [];

      for (let m = 1; m <= maxMonths; m++) {
        let total = 0;
        loansList.forEach(l => {
          const initial = l.purchasePrice;
          // accrued interest during grace months up to m
          const accrued = l.amort.schedule
            .filter(s => s.monthIndex <= m && s.payment === 0)
            .reduce((s, r) => s + r.interest, 0);
          // cumulative payments to date up to m
          const payments = l.amort.schedule
            .filter(s => s.monthIndex <= m)
            .reduce((s, r) => s + r.payment, 0);

          total += initial + accrued + payments;
        });
        series.push({ month: m, value: total });
      }

      return series;
    }

    const tpvSeriesData = tpvSeries(loansWithAmort);
    document.getElementById('tpvTile').textContent =
      `$${Math.round(tpvSeriesData[Math.min(CURRENT_MONTH - 1, tpvSeriesData.length - 1)].value).toLocaleString()}`;

    /* ============================
       Render loan tiles with mini-charts (cumulative principal & interest)
       ============================ */
    const grid = document.getElementById('loanGrid');
    const tooltip = document.getElementById('tooltip');

    loansWithAmort.forEach((loan, idx) => {
      const tile = document.createElement('div');
      tile.className = 'tile';
      tile.setAttribute('tabindex', '0');

      tile.innerHTML = `
        <div class="tile-left">
          <div class="loan-name">Loan ${loan.id}</div>
          <div class="loan-sub">$${loan.purchasePrice.toLocaleString()}</div>
          <div class="loan-meta"><div>Term: ${loan.termYears}y</div><div>Grace: ${loan.graceYears}y</div></div>
        </div>

        <div class="chart-wrap">
          <div class="mini-label">Rate ${(loan.nominalRate * 100).toFixed(2)}%</div>
          <svg class="sparkline" viewBox="0 0 170 48" preserveAspectRatio="none" data-idx="${idx}" aria-hidden="true"></svg>
        </div>
      `;

      // Important: stop propagation on click so the page-level click listener doesn't close the drawer immediately.
      tile.addEventListener('click', e => { e.stopPropagation(); openDrawerForLoan(loan); });
      tile.addEventListener('keydown', e => { if (e.key === 'Enter' || e.key === ' ') { e.preventDefault(); openDrawerForLoan(loan); } });

      grid.appendChild(tile);

      // render mini sparkline
      const svg = tile.querySelector('svg.sparkline');
      const w = 170, h = 48, pad = 6;
      const fullSched = loan.cumSchedule;
      const pPoints = fullSched.map(s => ({ y: s.cumPrincipal }));
      const iPoints = fullSched.map(s => ({ y: s.cumInterest }));

      const pathP = buildPathFromPoints(pPoints, w, h, pad);
      const pathI = buildPathFromPoints(iPoints, w, h, pad);

      const maxMonth = Math.max(1, fullSched.length);
      const xForMonth = month => {
        const stepX = (w - pad * 2) / Math.max(1, maxMonth - 1);
        return pad + (Math.min(Math.max(month, 1), maxMonth) - 1) * stepX;
      };

      svg.innerHTML = `
        <path d="${pathI}" fill="none" stroke="#a78bfa" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round" data-series="interest"></path>
        <path d="${pathP}" fill="none" stroke="#06b6d4" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round" data-series="principal"></path>
        <g class="mini-hover"></g>
        <line class="current-line" x1="${xForMonth(CURRENT_MONTH)}" y1="2" x2="${xForMonth(CURRENT_MONTH)}" y2="${h - 2}" stroke="#111827" stroke-dasharray="3 3" stroke-opacity="0.6" />
      `;

      // Hover tooltip for mini chart
      svg.addEventListener('mousemove', ev => {
        const rect = svg.getBoundingClientRect();
        const relativeX = ev.clientX - rect.left;
        const frac = relativeX / rect.width;
        const idxNearest = Math.round(frac * (fullSched.length - 1));
        const p = fullSched[Math.max(0, Math.min(fullSched.length - 1, idxNearest))];

        tooltip.style.left = (ev.clientX) + 'px';
        tooltip.style.top = (ev.clientY - 10) + 'px';
        tooltip.style.display = 'block';
        tooltip.innerHTML = `M${p.monthIndex} • Principal $${p.cumPrincipal.toLocaleString()} • Interest $${p.cumInterest.toLocaleString()}`;

        // draw hover circles
        const hoverG = svg.querySelector('g.mini-hover');
        hoverG.innerHTML = '';
        const svgNS = 'http://www.w3.org/2000/svg';
        const stepX = (w - pad * 2) / Math.max(1, fullSched.length - 1);
        const iX = pad + idxNearest * stepX;

        const valsP = pPoints.map(pp => pp.y);
        const valsI = iPoints.map(pp => pp.y);
        const minP = Math.min(...valsP), maxP = Math.max(...valsP), rangeP = Math.max(1, maxP - minP);
        const minI = Math.min(...valsI), maxI = Math.max(...valsI), rangeI = Math.max(1, maxI - minI);

        const cyP = pad + (h - pad * 2) - ((p.cumPrincipal - minP) / rangeP) * (h - pad * 2);
        const cyI = pad + (h - pad * 2) - ((p.cumInterest - minI) / rangeI) * (h - pad * 2);

        const cP = document.createElementNS(svgNS, 'circle');
        cP.setAttribute('cx', iX); cP.setAttribute('cy', cyP); cP.setAttribute('r', 3.4); cP.setAttribute('fill', '#06b6d4'); cP.setAttribute('stroke', '#fff'); cP.setAttribute('stroke-width', '1');
        hoverG.appendChild(cP);

        const cI = document.createElementNS(svgNS, 'circle');
        cI.setAttribute('cx', iX); cI.setAttribute('cy', cyI); cI.setAttribute('r', 3.4); cI.setAttribute('fill', '#a78bfa'); cI.setAttribute('stroke', '#fff'); cI.setAttribute('stroke-width', '1');
        hoverG.appendChild(cI);
      });

      svg.addEventListener('mouseleave', () => {
        tooltip.style.display = 'none';
        const hoverG = svg.querySelector('g.mini-hover');
        if (hoverG) hoverG.innerHTML = '';
      });
    });

    /* ============================
       Drawer helpers
       ============================ */
    const drawer = document.getElementById('drawer');
    const drawerTitle = document.getElementById('drawerTitle');
    const drawerSub = document.getElementById('drawerSub');
    const drawerPrimary = document.getElementById('drawerPrimary');
    const drawerSecondary = document.getElementById('drawerSecondary');
    const drawerPrimaryTitle = document.getElementById('drawerPrimaryTitle');
    const drawerSecondaryTitle = document.getElementById('drawerSecondaryTitle');
    const amortBody = document.getElementById('amortBody');
    const drawerChartArea = document.getElementById('drawerChartArea');
    const drawerLegend = document.getElementById('drawerLegend');
    const drawerExtra = document.getElementById('drawerExtra');
    const drawerAmortContainer = document.getElementById('drawerAmortContainer');

    document.getElementById('closeBtn').addEventListener('click', () => closeDrawer());
    document.addEventListener('keydown', (e) => { if (e.key === 'Escape') closeDrawer(); });

    let currentLoan = null;
    let currentMode = null; // 'loan' or 'kpi'

    function closeDrawer() {
      drawer.classList.remove('open');
      drawer.setAttribute('aria-hidden', 'true');
      tooltip.style.display = 'none';
      currentLoan = null;
      currentMode = null;
    }

    /* ---------- Open drawer for loan ---------- */
    function openDrawerForLoan(loan) {
      drawerExtra.innerHTML = '';
      currentMode = 'loan';
      currentLoan = loan;

      drawerTitle.textContent = `Loan ${loan.id}`;
      drawerSub.textContent = `Purchased: ${loan.purchaseDate}`;
      drawerPrimaryTitle.textContent = 'Purchase Price';
      drawerSecondaryTitle.textContent = 'Rate';
      drawerPrimary.textContent = `$${loan.purchasePrice.toLocaleString()}`;
      drawerSecondary.textContent = `${(loan.nominalRate * 100).toFixed(2)}%`;

      /* render amort rows */
      drawerAmortContainer.style.display = 'block';
      amortBody.innerHTML = '';
      loan.amort.schedule.forEach(r => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td style="text-align:left">${r.monthIndex}</td>
          <td style="text-align:right">$${Number(r.payment).toFixed(2)}</td>
          <td style="text-align:right">$${Number(r.principalPaid).toFixed(2)}</td>
          <td style="text-align:right">$${Number(r.interest).toFixed(2)}</td>
          <td style="text-align:right">$${Number(r.balance).toFixed(2)}</td>
        `;
        amortBody.appendChild(tr);
      });

      /* build drawer chart (multi-line with legend & current date marker) */
      drawerChartArea.innerHTML = '';
      drawerLegend.style.display = 'flex';
      drawerLegend.innerHTML = `
        <div class="item"><span class="sw" style="background:#0f172a"></span>Balance</div>
        <div class="item"><span class="sw" style="background:#06b6d4"></span>Cum Principal</div>
        <div class="item"><span class="sw" style="background:#a78bfa"></span>Cum Interest</div>
        <div class="item"><span class="sw" style="background:#fb7185"></span>Total</div>
      `;

      const svgNS = 'http://www.w3.org/2000/svg';
      const w = 480, h = 240, pad = 28;
      const svg = document.createElementNS(svgNS, 'svg');
      svg.setAttribute('viewBox', `0 0 ${w} ${h}`);
      svg.setAttribute('width', '100%');
      svg.setAttribute('height', '100%');

      const schedule = loan.cumSchedule;
      const balances = loan.amort.schedule.map(s => ({ x: s.monthIndex, y: s.balance }));
      const cumP = schedule.map(s => ({ x: s.monthIndex, y: s.cumPrincipal }));
      const cumI = schedule.map(s => ({ x: s.monthIndex, y: s.cumInterest }));
      const cumT = schedule.map(s => ({ x: s.monthIndex, y: s.cumTotal }));

      // global Y range for consistent scaling
      const allYs = [
        ...balances.map(p => p.y),
        ...cumP.map(p => p.y),
        ...cumI.map(p => p.y),
        ...cumT.map(p => p.y)
      ];
      const maxY = Math.max(...allYs);
      const minY = Math.min(...allYs);
      const range = Math.max(1, maxY - minY);

      const stepX = (w - pad * 2) / Math.max(1, schedule.length - 1);
      function toXY(point, i) {
        const x = pad + i * stepX;
        const y = pad + (h - pad * 2) - ((point.y - minY) / range) * (h - pad * 2);
        return [x, y];
      }
      function buildPath(arr) {
        return arr.map((p, i) => {
          const [x, y] = toXY(p, i);
          return (i === 0 ? `M ${x} ${y}` : ` L ${x} ${y}`);
        }).join(' ');
      }

      // subtle grid lines
      for (let gy = 0; gy < 5; gy++) {
        const y = pad + gy * ((h - pad * 2) / 4);
        const line = document.createElementNS(svgNS, 'line');
        line.setAttribute('x1', pad);
        line.setAttribute('x2', w - pad);
        line.setAttribute('y1', y);
        line.setAttribute('y2', y);
        line.setAttribute('stroke', '#eef2f7');
        line.setAttribute('stroke-width', '1');
        svg.appendChild(line);
      }

      const pathBal = buildPath(balances);
      const pathP = buildPath(cumP);
      const pathI = buildPath(cumI);
      const pathT = buildPath(cumT);

      const elBal = document.createElementNS(svgNS, 'path');
      elBal.setAttribute('d', pathBal);
      elBal.setAttribute('fill', 'none');
      elBal.setAttribute('stroke', '#0f172a');
      elBal.setAttribute('stroke-width', '2');
      svg.appendChild(elBal);

      const elP = document.createElementNS(svgNS, 'path');
      elP.setAttribute('d', pathP);
      elP.setAttribute('fill', 'none');
      elP.setAttribute('stroke', '#06b6d4');
      elP.setAttribute('stroke-width', '1.6');
      svg.appendChild(elP);

      const elI = document.createElementNS(svgNS, 'path');
      elI.setAttribute('d', pathI);
      elI.setAttribute('fill', 'none');
      elI.setAttribute('stroke', '#a78bfa');
      elI.setAttribute('stroke-width', '1.6');
      svg.appendChild(elI);

      const elT = document.createElementNS(svgNS, 'path');
      elT.setAttribute('d', pathT);
      elT.setAttribute('fill', 'none');
      elT.setAttribute('stroke', '#fb7185');
      elT.setAttribute('stroke-width', '1.4');
      svg.appendChild(elT);

      // current date marker
      const maxMonth = schedule.length;
      const curX = pad + (Math.max(1, Math.min(CURRENT_MONTH, maxMonth)) - 1) * stepX;
      const curLine = document.createElementNS(svgNS, 'line');
      curLine.setAttribute('x1', curX);
      curLine.setAttribute('x2', curX);
      curLine.setAttribute('y1', pad);
      curLine.setAttribute('y2', h - pad);
      curLine.setAttribute('stroke', '#111827');
      curLine.setAttribute('stroke-dasharray', '3 4');
      curLine.setAttribute('stroke-opacity', '0.6');
      svg.appendChild(curLine);

      // hover overlay (vertical line and circles)
      const vLine = document.createElementNS(svgNS, 'line');
      vLine.setAttribute('stroke', '#0f172a');
      vLine.setAttribute('stroke-width', '1');
      vLine.setAttribute('stroke-dasharray', '3 4');
      vLine.setAttribute('opacity', '0.6');
      svg.appendChild(vLine);

      const circles = document.createElementNS(svgNS, 'g');
      svg.appendChild(circles);

      svg.addEventListener('mousemove', (ev) => {
        const rect = svg.getBoundingClientRect();
        const x = ev.clientX - rect.left;
        let idx = Math.round((x - pad) / stepX);
        idx = Math.max(0, Math.min(schedule.length - 1, idx));
        const px = pad + idx * stepX;

        vLine.setAttribute('x1', px); vLine.setAttribute('x2', px);
        vLine.setAttribute('y1', pad); vLine.setAttribute('y2', h - pad);
        circles.innerHTML = '';

        const pointVals = {
          month: schedule[idx].monthIndex,
          balance: balances[idx].y,
          cumP: cumP[idx].y,
          cumI: cumI[idx].y,
          cumT: cumT[idx].y
        };

        const series = [
          { val: pointVals.balance, color: '#0f172a' },
          { val: pointVals.cumP, color: '#06b6d4' },
          { val: pointVals.cumI, color: '#a78bfa' },
          { val: pointVals.cumT, color: '#fb7185' }
        ];

        series.forEach(s => {
          const [cx, cy] = toXY({ y: s.val }, idx);
          const c = document.createElementNS(svgNS, 'circle');
          c.setAttribute('cx', cx);
          c.setAttribute('cy', cy);
          c.setAttribute('r', 4);
          c.setAttribute('fill', s.color);
          c.setAttribute('stroke', '#fff');
          c.setAttribute('stroke-width', '1.2');
          circles.appendChild(c);
        });

        tooltip.style.display = 'block';
        tooltip.style.left = (rect.left + px) + 'px';
        tooltip.style.top = (rect.top + 16) + 'px';
        tooltip.innerHTML = `M${pointVals.month} — Balance $${pointVals.balance.toLocaleString()}<br>Principal $${pointVals.cumP.toLocaleString()} • Interest $${pointVals.cumI.toLocaleString()} • Total $${pointVals.cumT.toLocaleString()}`;
      });

      svg.addEventListener('mouseleave', () => {
        vLine.setAttribute('x1', 0); vLine.setAttribute('x2', 0);
        circles.innerHTML = '';
        tooltip.style.display = 'none';
      });

      drawerChartArea.appendChild(svg);

      drawer.classList.add('open');
      drawer.setAttribute('aria-hidden', 'false');
      drawer.scrollTop = 0;
    }

    /* ============================
       KPI drawers: Distribution, TPV, Rates, Payments
       (each removes amortization as requested)
       ============================ */

    function monthLabel(dateStr) {
      const d = new Date(dateStr + 'T00:00:00');
      return d.toLocaleString(undefined, { year: 'numeric', month: 'short' });
    }

    function renderDistributionDrawer() {
      currentMode = 'kpi';
      currentLoan = null;

      drawerTitle.textContent = 'Distribution — Loans by Purchase Month';
      drawerSub.textContent = 'Number of loans purchased by month';
      drawerPrimaryTitle.textContent = '';
      drawerPrimary.textContent = '';
      drawerSecondaryTitle.textContent = 'Total Invested';

      const totalInvested = loansWithAmort.reduce((s, l) => s + l.purchasePrice, 0);
      drawerSecondary.textContent = `$${totalInvested.toLocaleString()}`;

      drawerAmortContainer.style.display = 'none';
      drawerExtra.innerHTML = '';

      // counts by month
      const counts = {};
      loansWithAmort.forEach(l => { const m = monthLabel(l.purchaseDate); counts[m] = (counts[m] || 0) + 1; });
      const months = Object.keys(counts);

      drawerChartArea.innerHTML = '';
      drawerLegend.style.display = 'none';

      // simple bar chart SVG
      const svgNS = 'http://www.w3.org/2000/svg';
      const w = 480, h = 220, pad = 30;
      const svg = document.createElementNS(svgNS, 'svg');
      svg.setAttribute('viewBox', `0 0 ${w} ${h}`);
      svg.setAttribute('width', '100%');
      svg.setAttribute('height', '100%');

      const maxCount = Math.max(...Object.values(counts));
      months.forEach((m, i) => {
        const barW = (w - pad * 2) / months.length * 0.7;
        const gap = ((w - pad * 2) / months.length - barW) / 2;
        const x = pad + i * ((w - pad * 2) / months.length) + gap;
        const barH = (counts[m] / Math.max(1, maxCount)) * (h - pad * 2);
        const y = h - pad - barH;

        const rect = document.createElementNS(svgNS, 'rect');
        rect.setAttribute('x', x); rect.setAttribute('y', y);
        rect.setAttribute('width', barW); rect.setAttribute('height', barH);
        rect.setAttribute('fill', '#06b6d4');
        svg.appendChild(rect);

        const text = document.createElementNS(svgNS, 'text');
        text.setAttribute('x', x + barW / 2);
        text.setAttribute('y', h - pad + 14);
        text.setAttribute('font-size', '11');
        text.setAttribute('text-anchor', 'middle');
        text.setAttribute('fill', '#475569');
        text.textContent = m;
        svg.appendChild(text);

        rect.addEventListener('mousemove', (ev) => {
          tooltip.style.display = 'block';
          tooltip.style.left = ev.clientX + 'px';
          tooltip.style.top = (ev.clientY - 12) + 'px';
          tooltip.innerHTML = `${m} • ${counts[m]} loans`;
        });
        rect.addEventListener('mouseleave', () => tooltip.style.display = 'none');
      });

      // current month marker on the right edge (visual cue)
      const curLine = document.createElementNS(svgNS, 'line');
      curLine.setAttribute('x1', pad + (w - pad * 2));
      curLine.setAttribute('x2', pad + (w - pad * 2));
      curLine.setAttribute('y1', pad);
      curLine.setAttribute('y2', h - pad);
      curLine.setAttribute('stroke', '#111827');
      curLine.setAttribute('stroke-dasharray', '3 4');
      curLine.setAttribute('stroke-opacity', '0.3');
      svg.appendChild(curLine);

      drawerChartArea.appendChild(svg);

      // table listing loans
      drawerExtra.innerHTML = `
        <div style="margin-top:10px">
          <strong class="small">Loans</strong>
          <div style="max-height:220px; overflow:auto; margin-top:6px; border-radius:6px; padding:6px; border:1px solid #f0f3f7">
            <table style="width:100%; font-size:13px">
              <thead>
                <tr><th>Loan</th><th>Purchase</th><th>Rate</th><th style="text-align:right">Balance</th></tr>
              </thead>
              <tbody>
                ${loansWithAmort.map(l => `<tr>
                  <td style="text-align:left">Loan ${l.id}</td>
                  <td style="text-align:left">${l.purchaseDate}</td>
                  <td style="text-align:left">${(l.nominalRate * 100).toFixed(2)}%</td>
                  <td style="text-align:right">$${l.purchasePrice.toLocaleString()}</td>
                </tr>`).join('')}
              </tbody>
            </table>
          </div>
        </div>
      `;

      drawer.classList.add('open');
      drawer.setAttribute('aria-hidden', 'false');
    }

    function renderTPVDrawer() {
      currentMode = 'kpi';
      currentLoan = null;

      drawerTitle.textContent = 'Total Portfolio Value';
      drawerSub.textContent = 'Purchase + accrued interest (grace) + cumulative payments';

      drawerPrimaryTitle.textContent = 'Current TPV';
      const curVal = tpvSeriesData[Math.min(CURRENT_MONTH - 1, tpvSeriesData.length - 1)].value;
      drawerPrimary.textContent = `$${Math.round(curVal).toLocaleString()}`;

      drawerSecondaryTitle.textContent = 'Total Invested';
      drawerSecondary.textContent = `$${loansWithAmort.reduce((s, l) => s + l.purchasePrice, 0).toLocaleString()}`;

      drawerAmortContainer.style.display = 'none';
      drawerExtra.innerHTML = '';
      drawerChartArea.innerHTML = '';
      drawerLegend.style.display = 'none';

      // draw TPV series
      const svgNS = 'http://www.w3.org/2000/svg';
      const w = 480, h = 220, pad = 30;
      const svg = document.createElementNS(svgNS, 'svg');
      svg.setAttribute('viewBox', `0 0 ${w} ${h}`);
      svg.setAttribute('width', '100%');
      svg.setAttribute('height', '100%');

      const vals = tpvSeriesData.map(d => d.value);
      const maxV = Math.max(...vals);
      const minV = Math.min(...vals);
      const range = Math.max(1, maxV - minV);
      const stepX = (w - pad * 2) / Math.max(1, tpvSeriesData.length - 1);

      let pts = '';
      tpvSeriesData.forEach((d, i) => {
        const x = pad + i * stepX;
        const y = pad + (h - pad * 2) - ((d.value - minV) / range) * (h - pad * 2);
        pts += `${x},${y} `;
      });

      const poly = document.createElementNS(svgNS, 'polyline');
      poly.setAttribute('points', pts);
      poly.setAttribute('fill', 'none');
      poly.setAttribute('stroke', '#0ea5e9');
      poly.setAttribute('stroke-width', '2');
      svg.appendChild(poly);

      // sparse x labels
      for (let i = 0; i < tpvSeriesData.length; i += Math.max(1, Math.floor(tpvSeriesData.length / 6))) {
        const x = pad + i * stepX;
        const text = document.createElementNS(svgNS, 'text');
        text.setAttribute('x', x);
        text.setAttribute('y', h - pad + 14);
        text.setAttribute('font-size', '11');
        text.setAttribute('text-anchor', 'middle');
        text.setAttribute('fill', '#475569');
        text.textContent = `M${tpvSeriesData[i].month}`;
        svg.appendChild(text);
      }

      // current month marker
      const curIdx = Math.min(CURRENT_MONTH - 1, tpvSeriesData.length - 1);
      const curX = pad + curIdx * stepX;
      const curLine = document.createElementNS(svgNS, 'line');
      curLine.setAttribute('x1', curX); curLine.setAttribute('x2', curX);
      curLine.setAttribute('y1', pad); curLine.setAttribute('y2', h - pad);
      curLine.setAttribute('stroke', '#111827');
      curLine.setAttribute('stroke-dasharray', '3 4');
      curLine.setAttribute('stroke-opacity', '0.6');
      svg.appendChild(curLine);

      // hover hit rects
      tpvSeriesData.forEach((d, i) => {
        const x = pad + i * stepX;
        const hit = document.createElementNS(svgNS, 'rect');
        hit.setAttribute('x', x - stepX / 2);
        hit.setAttribute('y', pad);
        hit.setAttribute('width', Math.max(1, stepX));
        hit.setAttribute('height', h - pad * 2);
        hit.setAttribute('fill', 'transparent');
        hit.addEventListener('mousemove', (ev) => {
          tooltip.style.display = 'block';
          tooltip.style.left = ev.clientX + 'px';
          tooltip.style.top = (ev.clientY - 12) + 'px';
          tooltip.innerHTML = `M${d.month} • TPV $${Math.round(d.value).toLocaleString()}`;
        });
        hit.addEventListener('mouseleave', () => tooltip.style.display = 'none');
        svg.appendChild(hit);
      });

      drawerChartArea.appendChild(svg);

      // TPV snapshot table
      const curValRounded = Math.round(tpvSeriesData[curIdx].value);
      drawerExtra.innerHTML = `
        <div style="margin-top:10px">
          <strong class="small">TPV Snapshot</strong>
          <div style="max-height:140px;overflow:auto;margin-top:6px;border-radius:6px;padding:6px;border:1px solid #f0f3f7">
            <table style="width:100%;font-size:13px">
              <thead><tr><th>Month</th><th style="text-align:right">TPV</th></tr></thead>
              <tbody>
                <tr><td style="text-align:left">Start (M1)</td><td style="text-align:right">$${Math.round(tpvSeriesData[0].value).toLocaleString()}</td></tr>
                <tr><td style="text-align:left">Current (M${CURRENT_MONTH})</td><td style="text-align:right">$${curValRounded.toLocaleString()}</td></tr>
                <tr><td style="text-align:left">End (M${tpvSeriesData[tpvSeriesData.length - 1].month})</td><td style="text-align:right">$${Math.round(tpvSeriesData[tpvSeriesData.length - 1].value).toLocaleString()}</td></tr>
              </tbody>
            </table>
          </div>
        </div>
      `;

      drawer.classList.add('open');
      drawer.setAttribute('aria-hidden', 'false');
    }

    function renderRatesDrawer() {
      currentMode = 'kpi';
      currentLoan = null;

      drawerTitle.textContent = 'Rates Distribution';
      drawerSub.textContent = 'Histogram of loan nominal rates';
      drawerPrimaryTitle.textContent = 'Avg Rate';
      drawerPrimary.textContent = `${kpis.weightedRate.toFixed(2)}%`;
      drawerSecondaryTitle.textContent = '';
      drawerSecondary.textContent = '';

      drawerAmortContainer.style.display = 'none';
      drawerExtra.innerHTML = '';
      drawerChartArea.innerHTML = '';
      drawerLegend.style.display = 'none';

      // histogram
      const rates = loansWithAmort.map(l => l.nominalRate * 100);
      const min = Math.min(...rates), max = Math.max(...rates);
      const bins = 5;
      const width = (max - min) / bins || 1;
      const counts = new Array(bins).fill(0);
      rates.forEach(r => {
        let idx = Math.floor((r - min) / Math.max(0.0001, width));
        if (idx >= bins) idx = bins - 1;
        counts[idx]++;
      });

      const svgNS = 'http://www.w3.org/2000/svg';
      const w = 480, h = 220, pad = 30;
      const svg = document.createElementNS(svgNS, 'svg');
      svg.setAttribute('viewBox', `0 0 ${w} ${h}`);
      svg.setAttribute('width', '100%');
      svg.setAttribute('height', '100%');

      const maxC = Math.max(...counts, 1);
      for (let i = 0; i < bins; i++) {
        const barW = (w - pad * 2) / bins * 0.7;
        const gap = ((w - pad * 2) / bins - barW) / 2;
        const x = pad + i * ((w - pad * 2) / bins) + gap;
        const barH = (counts[i] / maxC) * (h - pad * 2);
        const y = h - pad - barH;

        const rect = document.createElementNS(svgNS, 'rect');
        rect.setAttribute('x', x);
        rect.setAttribute('y', y);
        rect.setAttribute('width', barW);
        rect.setAttribute('height', barH);
        rect.setAttribute('fill', '#7c3aed');
        svg.appendChild(rect);

        const label = `${(min + i * width).toFixed(2)}-${(min + (i + 1) * width).toFixed(2)}`;
        const text = document.createElementNS(svgNS, 'text');
        text.setAttribute('x', x + barW / 2);
        text.setAttribute('y', h - pad + 14);
        text.setAttribute('font-size', '11');
        text.setAttribute('text-anchor', 'middle');
        text.setAttribute('fill', '#475569');
        text.textContent = label;
        svg.appendChild(text);

        rect.addEventListener('mousemove', (ev) => {
          tooltip.style.display = 'block';
          tooltip.style.left = ev.clientX + 'px';
          tooltip.style.top = (ev.clientY - 12) + 'px';
          tooltip.innerHTML = `${counts[i]} loans (${label}%)`;
        });
        rect.addEventListener('mouseleave', () => tooltip.style.display = 'none');
      }

      drawerChartArea.appendChild(svg);

      // table sorted by rate
      const sorted = loansWithAmort.slice().sort((a, b) => b.nominalRate - a.nominalRate);
      drawerExtra.innerHTML = `
        <div style="margin-top:10px">
          <strong class="small">Loans sorted by rate</strong>
          <div style="max-height:240px;overflow:auto;margin-top:6px;border-radius:6px;padding:6px;border:1px solid #f0f3f7">
            <table style="width:100%;font-size:13px">
              <thead><tr><th>Loan</th><th>Rate</th><th>Purchase</th><th style="text-align:right">Balance</th></tr></thead>
              <tbody>
                ${sorted.map(l => `<tr>
                  <td style="text-align:left">Loan ${l.id}</td>
                  <td style="text-align:left">${(l.nominalRate * 100).toFixed(2)}%</td>
                  <td style="text-align:left">${l.purchaseDate}</td>
                  <td style="text-align:right">$${l.purchasePrice.toLocaleString()}</td>
                </tr>`).join('')}
              </tbody>
            </table>
          </div>
        </div>
      `;

      drawer.classList.add('open');
      drawer.setAttribute('aria-hidden', 'false');
    }

    function renderPaymentsDrawer() {
      currentMode = 'kpi';
      currentLoan = null;

      drawerTitle.textContent = 'Total Expected Payments (monthly)';
      drawerSub.textContent = 'Sum of scheduled payments across loans';
      drawerPrimaryTitle.textContent = 'Monthly Income';
      drawerPrimary.textContent = `$${Math.round(kpis.monthlyIncome).toLocaleString()}`;
      drawerSecondaryTitle.textContent = 'Total Invested';
      drawerSecondary.textContent = `$${kpis.total.toLocaleString()}`;

      drawerAmortContainer.style.display = 'none';
      drawerExtra.innerHTML = '';

      // Build months from earliest purchase to last schedule end
      const monthIndex = d => new Date(d + 'T00:00:00').getTime();
      const minDate = Math.min(...loansWithAmort.map(l => monthIndex(l.purchaseDate)));
      const maxDate = Math.max(...loansWithAmort.map(l => {
        const lastMonth = l.amort.schedule[l.amort.schedule.length - 1].monthIndex;
        const pd = new Date(l.purchaseDate + 'T00:00:00');
        pd.setMonth(pd.getMonth() + lastMonth);
        return pd.getTime();
      }));

      const months = [];
      const cursor = new Date(minDate);
      cursor.setDate(1);
      while (cursor.getTime() <= maxDate) {
        months.push(new Date(cursor.getTime()).toISOString().slice(0, 7));
        cursor.setMonth(cursor.getMonth() + 1);
      }

      // compute total payments by month
      const paymentsByMonth = months.map(m => {
        return loansWithAmort.reduce((s, l) => {
          const pd = new Date(l.purchaseDate + 'T00:00:00');
          const ym = m.split('-');
          const md = new Date(parseInt(ym[0]), parseInt(ym[1]) - 1, 1);
          const monthsSince = (md.getFullYear() - pd.getFullYear()) * 12 + (md.getMonth() - pd.getMonth());
          const idx = Math.max(0, monthsSince);
          const entry = l.amort.schedule[Math.min(l.amort.schedule.length - 1, idx)];
          s += entry ? entry.payment : 0;
          return s;
        }, 0);
      });

      // timeseries chart
      drawerChartArea.innerHTML = '';
      drawerLegend.style.display = 'none';
      const svgNS = 'http://www.w3.org/2000/svg';
      const w = 480, h = 220, pad = 30;
      const svg = document.createElementNS(svgNS, 'svg');
      svg.setAttribute('viewBox', `0 0 ${w} ${h}`);
      svg.setAttribute('width', '100%');
      svg.setAttribute('height', '100%');

      const maxPay = Math.max(...paymentsByMonth);
      const minPay = Math.min(...paymentsByMonth);
      const range = Math.max(1, maxPay - minPay);
      const stepX = (w - pad * 2) / Math.max(1, months.length - 1);

      let pts = '';
      paymentsByMonth.forEach((p, i) => {
        const x = pad + i * stepX;
        const y = pad + (h - pad * 2) - ((p - minPay) / range) * (h - pad * 2);
        pts += `${x},${y} `;
      });

      const poly = document.createElementNS(svgNS, 'polyline');
      poly.setAttribute('points', pts);
      poly.setAttribute('fill', 'none');
      poly.setAttribute('stroke', '#fb7185');
      poly.setAttribute('stroke-width', '2');
      svg.appendChild(poly);

      months.forEach((m, i) => {
        const x = pad + i * stepX;
        const text = document.createElementNS(svgNS, 'text');
        text.setAttribute('x', x);
        text.setAttribute('y', h - pad + 14);
        text.setAttribute('font-size', '11');
        text.setAttribute('text-anchor', 'middle');
        text.setAttribute('fill', '#475569');
        text.textContent = m;
        svg.appendChild(text);

        const hit = document.createElementNS(svgNS, 'rect');
        hit.setAttribute('x', x - stepX / 2);
        hit.setAttribute('y', pad);
        hit.setAttribute('width', Math.max(1, stepX));
        hit.setAttribute('height', h - pad * 2);
        hit.setAttribute('fill', 'transparent');

        hit.addEventListener('mousemove', (ev) => {
          tooltip.style.display = 'block';
          tooltip.style.left = ev.clientX + 'px';
          tooltip.style.top = (ev.clientY - 12) + 'px';
          tooltip.innerHTML = `${m} • $${Math.round(paymentsByMonth[i]).toLocaleString()}`;
        });
        hit.addEventListener('mouseleave', () => tooltip.style.display = 'none');

        svg.appendChild(hit);
      });

      drawerChartArea.appendChild(svg);

      drawerExtra.innerHTML = `
        <div style="margin-top:10px">
          <strong class="small">Monthly expected payments</strong>
          <div style="max-height:220px;overflow:auto;margin-top:6px;border-radius:6px;padding:6px;border:1px solid #f0f3f7">
            <table style="width:100%;font-size:13px">
              <thead><tr><th>Month</th><th style="text-align:right">Payments</th></tr></thead>
              <tbody>
                ${months.map((m, i) => `<tr><td style="text-align:left">${m}</td><td style="text-align:right">$${Math.round(paymentsByMonth[i]).toLocaleString()}</td></tr>`).join('')}
              </tbody>
            </table>
          </div>
        </div>
      `;

      drawer.classList.add('open');
      drawer.setAttribute('aria-hidden', 'false');
    }

    /* ============================
       Wire KPI clicks
       ============================ */
    document.querySelectorAll('.kpi').forEach(k => {
      k.addEventListener('click', (ev) => {
        ev.stopPropagation();
        const key = k.getAttribute('data-kpi');
        if (key === 'distribution') renderDistributionDrawer();
        if (key === 'tpv') renderTPVDrawer();
        if (key === 'rates') renderRatesDrawer();
        if (key === 'payments') renderPaymentsDrawer();
      });
    });

    /* ============================
       CSV / copy / download / print
       ============================ */
    function amortToCSV(loan) {
      const rows = [['Month', 'Payment', 'Principal', 'Interest', 'Balance']];
      loan.amort.schedule.forEach(r =>
        rows.push([r.monthIndex, r.payment.toFixed(2), r.principalPaid.toFixed(2), r.interest.toFixed(2), r.balance.toFixed(2)])
      );
      return rows.map(r => r.join(',')).join('\n');
    }

    document.getElementById('copyCsvBtn')?.addEventListener('click', async () => {
      if (currentMode !== 'loan' || !currentLoan) return alert('Open an individual loan drawer to copy CSV');
      const csv = amortToCSV(currentLoan);
      try { await navigator.clipboard.writeText(csv); alert('CSV copied to clipboard'); }
      catch (e) { alert('Copy failed — browser denied clipboard access'); }
    });

    document.getElementById('downloadCsvBtn')?.addEventListener('click', () => {
      if (currentMode === 'loan' && currentLoan) {
        const csv = amortToCSV(currentLoan);
        const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a'); a.href = url; a.download = `loan-${currentLoan.id}-amort.csv`;
        document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
      } else {
        alert('Download CSV is supported for individual loan drawers only.');
      }
    });

    document.getElementById('printBtn')?.addEventListener('click', () => window.print());

    // Accessibility tweak: hide tooltip when grid scrolls
    document.querySelector('.grid').addEventListener('scroll', () => tooltip.style.display = 'none');

    /* ============================
       Click outside to close drawer
       - If drawer is open, close it when user clicks anywhere that's
         not inside the drawer AND not on another tile.
       - Important: tile clicks call stopPropagation so the tile's click
         will open drawer and not cause immediate close.
       ============================ */
    document.addEventListener('click', function (e) {
      if (!drawer.classList.contains('open')) return;

      const clickedInsideDrawer = drawer.contains(e.target);
      const clickedTile = !!e.target.closest('.tile'); // matches all tiles

      // If the click is outside both drawer and tiles → close
      if (!clickedInsideDrawer && !clickedTile) {
        closeDrawer();
      }
    });
  </script>

<script>
const themeSwitch=document.getElementById('themeSwitch');
function applyTheme(t){
  document.documentElement.setAttribute('data-theme',t);
  localStorage.setItem('theme',t);
}
const savedTheme=localStorage.getItem('theme')||'light';
applyTheme(savedTheme);
if(themeSwitch) themeSwitch.checked = savedTheme==='dark';
themeSwitch?.addEventListener('change',e=>applyTheme(e.target.checked?'dark':'light'));
</script>

</body>
</html>
