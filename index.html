<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Loan Portfolio — ROI Dashboard (Dark Mode B)</title>
  <style>
    /* =========================
       Color system & dark mode
       ========================= */
    :root{
      --muted: #64748b;
      --card: #ffffff;
      --brand: #0ea5e9;
      --accent: #7c3aed;
      --surface: #f8fafc;
      --bg: linear-gradient(180deg,#f1f5f9 0%, #f8fafc 100%);
      --text: #0f172a;
      --shadow-1: 0 6px 18px rgba(16,24,40,0.04);
      --shadow-2: 0 12px 30px rgba(15,23,42,0.08);
      --border: rgba(15,23,42,0.04);
    }

    /* Full dark-mode variables (applied when html.dark exists) */
    html.dark {
      --muted: #94a3b8;
      --card: #0b1220;
      --brand: #38bdf8;
      --accent: #9b5cff;
      --surface: linear-gradient(180deg,#071024 0%, #071622 100%);
      --bg: linear-gradient(180deg,#071024 0%, #071622 100%);
      --text: #e6eef8;
      --shadow-1: 0 8px 26px rgba(2,6,23,0.6);
      --shadow-2: 0 18px 50px rgba(2,6,23,0.7);
      --border: rgba(255,255,255,0.06);
    }

    /* =========================
       Base layout
       ========================= */
    html,body{height:100%;margin:0;font-family:Inter,system-ui,-apple-system,"Segoe UI",Roboto,Arial;color:var(--text);-webkit-font-smoothing:antialiased}
    body{background:var(--bg)}
    .app{max-width:1200px;margin:18px auto;padding:16px}
    header{display:flex;flex-direction:column;gap:8px;margin-bottom:12px}
    .header-top{display:flex;align-items:center;justify-content:space-between;gap:12px}
    h1{font-size:20px;margin:0}
    p.lead{margin:0;color:var(--muted);font-size:13px}
    .current-date{font-size:13px;color:var(--muted);margin-top:4px}

    /* =========================
       Controls (dark toggle + header buttons)
       ========================= */
    .header-controls{display:flex;gap:10px;align-items:center}
    .theme-toggle{
      display:inline-flex;align-items:center;gap:8px;background:transparent;border:none;padding:8px;border-radius:8px;cursor:pointer;
      box-shadow:var(--shadow-1);border:1px solid var(--border);color:var(--text);
    }
    .theme-toggle .dot{width:18px;height:18px;border-radius:6px;display:inline-block;box-shadow:inset 0 0 0 2px rgba(255,255,255,0.06)}
    .theme-toggle[data-theme="light"]{background:linear-gradient(90deg, #fff, #f7fbff)}
    .theme-toggle[data-theme="dark"]{background:linear-gradient(90deg,#071022,#07182a)}
    /* visual parity buttons from Amort Page */
    .btn{padding:8px 10px;border-radius:8px;border:1px solid var(--border);background:transparent;cursor:pointer;font-weight:600}
    .btn.primary{background:linear-gradient(90deg,var(--brand),var(--accent));color:white;border:none;box-shadow:var(--shadow-1)}
    .close-btn{background:#f1f5f9;border:none;padding:8px;border-radius:8px;cursor:pointer}
    html.dark .close-btn{background:#0f172a;color:var(--text)}

    /* =========================
       KPI + grid
       ========================= */
    .kpis{display:grid;grid-template-columns:repeat(4,1fr);gap:12px;margin:14px 0 18px}
    .kpi{background:var(--card);padding:14px;border-radius:12px;box-shadow:var(--shadow-1);border:1px solid var(--border);cursor:pointer;transition:transform .18s,box-shadow .18s,transform .18s}
    .kpi:hover{transform:translateY(-6px);box-shadow:var(--shadow-2)}
    .kpi h3{margin:0;font-size:12px;color:var(--muted)}
    .kpi p{margin:8px 0 0;font-size:18px;font-weight:700}

    .grid{display:grid;grid-template-columns:repeat(2,1fr);gap:12px;height:calc(100vh - 360px);overflow:auto;padding-right:6px}
    @media(max-width:900px){.grid{grid-template-columns:1fr;height:auto}.kpis{grid-template-columns:repeat(2,1fr)}}

    .tile{display:flex;align-items:center;justify-content:space-between;padding:12px;border-radius:14px;background:var(--card);min-height:110px;cursor:pointer;overflow:hidden;transition:transform .18s ease,box-shadow .18s ease;border:1px solid var(--border);box-shadow:var(--shadow-1)}
    .tile:hover{transform:translateY(-6px);box-shadow:var(--shadow-2)}
    .tile-left{flex:1;padding-right:12px}
    .loan-name{font-weight:700;font-size:14px}
    .loan-sub{font-size:12px;color:var(--muted);margin-top:6px}
    .loan-meta{display:flex;gap:8px;font-size:12px;color:var(--muted);margin-top:8px}

    .chart-wrap{width:170px;flex-shrink:0;display:flex;flex-direction:column;align-items:flex-end}
    .mini-label{font-size:12px;color:var(--muted);margin-bottom:6px}
    svg.sparkline{width:170px;height:48px;display:block}

    /* =========================
       Drawer (right) — animation on open
       ========================= */
    .drawer{position:fixed;right:0;top:0;height:100vh;width:760px;max-width:100%;background:var(--card);box-shadow:-28px 0 80px rgba(2,6,23,0.14);transform:translateX(110%);transition:transform .36s cubic-bezier(.2,.9,.3,1),opacity .24s;z-index:90;overflow:auto;padding:20px;border-left:1px solid var(--border)}
    .drawer.open{transform:translateX(0);animation:drawerIn .28s ease forwards}
    @keyframes drawerIn{from{opacity:0;transform:translateX(24px)}to{opacity:1;transform:translateX(0)}}
    .drawer-head{display:flex;align-items:flex-start;justify-content:space-between;gap:8px}
    .drawer h2{margin:0 0 6px;font-size:20px}
    .muted{color:var(--muted);font-size:13px;margin-bottom:10px}

    .drawer-chart{height:260px;background:linear-gradient(180deg,#ffffff,#fcfeff);border-radius:8px;border:1px solid rgba(15,23,42,0.03);display:flex;align-items:center;justify-content:center;margin-bottom:8px;position:relative;padding:8px}
    html.dark .drawer-chart{background:linear-gradient(180deg,#071022,#071422);border:1px solid rgba(255,255,255,0.04)}

    .legend{display:flex;gap:10px;font-size:12px;align-items:center;margin-top:6px}
    .legend .item{display:flex;gap:6px;align-items:center}
    .legend .sw{width:12px;height:8px;border-radius:2px;display:inline-block}

    .amort-wrap{border:1px solid var(--border);border-radius:8px;padding:8px;max-height:40vh;overflow:auto}
    table{width:100%;border-collapse:collapse;font-size:13px}
    thead th{position:sticky;top:0;background:var(--card);padding:8px;text-align:left;color:var(--muted);font-weight:700}
    td{padding:8px;border-bottom:1px dashed rgba(15,23,42,0.04);text-align:right}
    td:first-child, th:first-child{text-align:left}

    .actions{display:flex;gap:8px;margin-top:12px}
    .tooltip{position:fixed;pointer-events:none;background:#0f172a;color:white;padding:6px 8px;border-radius:6px;font-size:12px;transform:translate(-50%,-120%);box-shadow:0 6px 18px rgba(2,6,23,0.2);display:none;z-index:9999;line-height:1.12}
    .small{font-size:12px;color:var(--muted)}

    /* fine-tuning for dark mode readability */
    html.dark .kpi, html.dark .tile{background:linear-gradient(180deg,#07122a,#081b2f)}
    html.dark .kpi h3, html.dark .small, html.dark thead th{color:var(--muted)}
  </style>
</head>
<body>
  <div class="app" role="main">
    <header>
      <div class="header-top">
        <div>
          <h1>Loan Portfolio — ROI Dashboard</h1>
          <p class="lead">Tiles, KPI drawers, full dark mode and animated drawer.</p>
        </div>

        <div class="header-controls">
          <div style="font-size:13px;color:var(--muted)">User: <strong style="color:var(--brand)">Jeff L Customer</strong></div>

          <!-- Dark mode toggle -->
          <button id="themeToggle" class="theme-toggle" aria-pressed="false" title="Toggle dark mode">
            <span id="themeIcon" class="dot" aria-hidden="true" style="background:var(--brand)"></span>
            <span id="themeLabel" style="font-size:13px;color:var(--muted)">Dark</span>
          </button>

          <button class="btn" id="downloadCsvBtnTop">Download CSV</button>
        </div>
      </div>

      <div class="current-date">Current Month: <strong id="currentMonthLabel">18</strong> (months since first purchase)</div>
    </header>

    <section class="kpis" id="kpis" aria-hidden="false"></section>
    <section class="grid" id="loanGrid" aria-live="polite"></section>
  </div>

  <aside id="drawer" class="drawer" aria-hidden="true">
    <div class="drawer-head">
      <div>
        <h2 id="drawerTitle">Drawer</h2>
        <div class="muted" id="drawerSub">details</div>
      </div>
      <div style="display:flex;gap:8px;align-items:center">
        <button class="btn" id="downloadCsvBtn">Download CSV</button>
        <button class="close-btn" id="closeBtn" aria-label="Close drawer">✕</button>
      </div>
    </div>

    <div style="display:flex;gap:12px;margin:12px 0">
      <div style="flex:1;background:var(--surface);padding:12px;border-radius:8px;border:1px solid var(--border)">
        <div id="drawerPrimaryTitle" class="small">Purchase Price</div>
        <div id="drawerPrimary" style="font-weight:800;font-size:18px"></div>
      </div>
      <div style="width:140px;background:var(--surface);padding:12px;border-radius:8px;border:1px solid var(--border);display:flex;flex-direction:column;justify-content:center">
        <div id="drawerSecondaryTitle" class="small">Rate</div>
        <div id="drawerSecondary" style="font-weight:800;font-size:16px"></div>
      </div>
    </div>

    <div id="drawerBody">
      <div class="drawer-chart" id="drawerChartArea"></div>
      <div class="legend" id="drawerLegend" style="display:none"></div>
      <div id="drawerExtra"></div>

      <div id="drawerAmortContainer" style="margin-top:12px">
        <h3 style="margin-top:8px">Amortization</h3>
        <div class="amort-wrap" id="amortWrap">
          <table>
            <thead>
              <tr><th>Month</th><th>Payment</th><th>Principal</th><th>Interest</th><th>Balance</th></tr>
            </thead>
            <tbody id="amortBody"></tbody>
          </table>
        </div>
      </div>

      <div class="actions" style="padding-top:12px">
        <button class="btn" id="printBtn">Print</button>
        <button class="btn primary" id="copyCsvBtn">Copy CSV</button>
      </div>
    </div>
  </aside>

  <div id="tooltip" class="tooltip" role="status" aria-live="polite"></div>

  <script>
  // Use DOMContentLoaded to avoid null references and to ensure single listeners.
  document.addEventListener('DOMContentLoaded', function () {
    /* ============================
       Constants + sample data
       ============================ */
    const CURRENT_MONTH = 18;
    document.getElementById('currentMonthLabel').textContent = CURRENT_MONTH;

    const loans = [
      { id:1, purchaseDate:'2025-01-15', purchasePrice:10000, termYears:10, graceYears:4.5, nominalRate:0.08 },
      { id:2, purchaseDate:'2025-02-01', purchasePrice:7500, termYears:8, graceYears:2, nominalRate:0.075 },
      { id:3, purchaseDate:'2025-02-20', purchasePrice:12000, termYears:12, graceYears:3, nominalRate:0.0825 },
      { id:4, purchaseDate:'2025-03-10', purchasePrice:6000, termYears:9, graceYears:1.5, nominalRate:0.095 },
      { id:5, purchaseDate:'2025-03-30', purchasePrice:5000, termYears:10, graceYears:1, nominalRate:0.09 },
      { id:6, purchaseDate:'2025-04-15', purchasePrice:7500, termYears:5, graceYears:0, nominalRate:0.073 },
      { id:7, purchaseDate:'2025-04-30', purchasePrice:10000, termYears:8, graceYears:0, nominalRate:0.09 },
      { id:8, purchaseDate:'2025-05-20', purchasePrice:5000, termYears:9, graceYears:0.5, nominalRate:0.11 },
      { id:9, purchaseDate:'2025-06-10', purchasePrice:10000, termYears:7, graceYears:0.25, nominalRate:0.10 },
      { id:10,purchaseDate:'2025-06-30', purchasePrice:8000, termYears:3, graceYears:0, nominalRate:0.06 }
    ];

    /* ============================
       Amortization / helpers
       ============================ */
    function calcAmort(principal, annualRate, termYears, graceYears) {
      const monthlyRate = annualRate / 12;
      const totalMonths = Math.round(termYears * 12);
      const graceMonths = Math.round(graceYears * 12);
      const repayMonths = Math.max(1, totalMonths - graceMonths);
      let balance = principal;
      const schedule = [];
      for (let m = 1; m <= graceMonths; m++) {
        const interest = +(balance * monthlyRate).toFixed(2);
        balance = +(balance + interest).toFixed(2);
        schedule.push({ monthIndex: m, payment: 0, principalPaid: 0, interest, balance });
      }
      const payment = monthlyRate === 0
        ? +(balance / repayMonths).toFixed(2)
        : +((balance * monthlyRate) / (1 - Math.pow(1 + monthlyRate, -repayMonths))).toFixed(2);
      for (let m = 1; m <= repayMonths; m++) {
        const interest = +(balance * monthlyRate).toFixed(2);
        const principalPaid = +Math.min(balance, +(payment - interest).toFixed(2));
        balance = +(Math.max(0, balance - principalPaid).toFixed(2));
        schedule.push({ monthIndex: graceMonths + m, payment: +payment.toFixed(2), principalPaid, interest, balance });
      }
      return { payment, schedule };
    }

    const loansWithAmort = loans.map(l => {
      const amort = calcAmort(l.purchasePrice, l.nominalRate, l.termYears, l.graceYears);
      let cumP = 0, cumI = 0, cumTotal = 0;
      const cumSchedule = amort.schedule.map(r => { cumP = +(cumP + r.principalPaid).toFixed(2); cumI = +(cumI + r.interest).toFixed(2); cumTotal = +(cumTotal + r.payment).toFixed(2); return { ...r, cumPrincipal: cumP, cumInterest: cumI, cumTotal }; });
      return { ...l, amort, cumSchedule };
    });

    function computeKPIs(list) {
      const total = list.reduce((s, l) => s + l.purchasePrice, 0);
      const weightedRate = list.reduce((s, l) => s + l.nominalRate * l.purchasePrice, 0) / Math.max(1, total);
      const monthlyIncome = list.reduce((s, l) => s + (l.amort.schedule.length ? l.amort.schedule[0].payment : 0), 0);
      return { total, weightedRate: weightedRate * 100, monthlyIncome };
    }
    const kpis = computeKPIs(loansWithAmort);

    /* ============================
       Simple SVG helpers
       ============================ */
    function buildPathFromPoints(points, w = 170, h = 48, pad = 6) {
      if (!points.length) return '';
      const ys = points.map(p => p.y);
      const minY = Math.min(...ys), maxY = Math.max(...ys);
      const range = Math.max(1e-6, maxY - minY);
      const stepX = (w - pad * 2) / Math.max(1, points.length - 1);
      return points.map((p, i) => {
        const x = pad + i * stepX;
        const y = pad + (h - pad * 2) - ((p.y - minY) / range) * (h - pad * 2);
        return (i === 0 ? 'M ' : ' L ') + x + ' ' + y;
      }).join('');
    }

    /* ============================
       Render KPI tiles & loan tiles
       ============================ */
    const kpisEl = document.getElementById('kpis');
    kpisEl.innerHTML = `
      <div class="kpi" data-kpi="distribution"><h3>Total Loans</h3><p>${loansWithAmort.length}</p></div>
      <div class="kpi" data-kpi="tpv"><h3>Total Invested</h3><p>$${kpis.total.toLocaleString()}</p></div>
      <div class="kpi" data-kpi="rates"><h3>Avg Rate</h3><p>${kpis.weightedRate.toFixed(2)}%</p></div>
      <div class="kpi" data-kpi="payments"><h3>Monthly Income</h3><p>$${kpis.monthlyIncome.toFixed(2)}</p></div>
    `;

    const grid = document.getElementById('loanGrid');
    const tooltip = document.getElementById('tooltip');

    loansWithAmort.forEach((loan, idx) => {
      const tile = document.createElement('div'); tile.className = 'tile'; tile.setAttribute('tabindex','0');
      tile.innerHTML = `
        <div class="tile-left">
          <div class="loan-name">Loan ${loan.id}</div>
          <div class="loan-sub">$${loan.purchasePrice.toLocaleString()}</div>
          <div class="loan-meta"><div>Term: ${loan.termYears}y</div><div>Grace: ${loan.graceYears}y</div></div>
        </div>
        <div class="chart-wrap">
          <div class="mini-label">Rate ${(loan.nominalRate*100).toFixed(2)}%</div>
          <svg class="sparkline" viewBox="0 0 170 48" preserveAspectRatio="none" data-idx="${idx}" aria-hidden="true"></svg>
        </div>
      `;
      tile.addEventListener('click', e => { e.stopPropagation(); openDrawerForLoan(loan); });
      tile.addEventListener('keydown', e => { if (e.key === 'Enter' || e.key === ' ') { e.preventDefault(); openDrawerForLoan(loan); } });
      grid.appendChild(tile);

      const svg = tile.querySelector('svg.sparkline');
      const w = 170, h = 48, pad = 6;
      const fullSched = loan.cumSchedule;
      const pPoints = fullSched.map(s => ({ y: s.cumPrincipal }));
      const iPoints = fullSched.map(s => ({ y: s.cumInterest }));
      const pathP = buildPathFromPoints(pPoints, w, h, pad);
      const pathI = buildPathFromPoints(iPoints, w, h, pad);
      svg.innerHTML = `
        <path d="${pathI}" fill="none" stroke="#a78bfa" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round"></path>
        <path d="${pathP}" fill="none" stroke="#06b6d4" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round"></path>
        <g class="mini-hover"></g>
      `;
      // current-month vertical marker for each mini chart — align by month index relative to purchase
      const earliest = loansWithAmort.reduce((d,l)=> l.purchaseDate < d ? l.purchaseDate : d, loansWithAmort[0].purchaseDate);
      const monthDiff = (d1,d2)=>{ const a=new Date(d1), b=new Date(d2); return (b.getFullYear()-a.getFullYear())*12+(b.getMonth()-a.getMonth()); };
      const diff = monthDiff(earliest, loan.purchaseDate);
      const currentIdxForLoan = Math.max(1, Math.min(fullSched.length, CURRENT_MONTH - diff));
      const stepX = (w - pad*2) / Math.max(1, fullSched.length - 1);
      const dashX = pad + (currentIdxForLoan - 1) * stepX;
      const line = document.createElementNS('http://www.w3.org/2000/svg','line');
      line.setAttribute('x1', dashX); line.setAttribute('x2', dashX); line.setAttribute('y1', 2); line.setAttribute('y2', h-2);
      line.setAttribute('stroke','#111827'); line.setAttribute('stroke-dasharray','3 3'); line.setAttribute('stroke-opacity','0.6');
      svg.appendChild(line);

      // mini hover
      svg.addEventListener('mousemove', ev => {
        const rect = svg.getBoundingClientRect();
        const relX = ev.clientX - rect.left;
        const frac = relX / rect.width;
        const idxNearest = Math.round(frac * (fullSched.length - 1));
        const p = fullSched[Math.max(0, Math.min(fullSched.length - 1, idxNearest))];
        tooltip.style.left = ev.clientX + 'px'; tooltip.style.top = (ev.clientY - 12) + 'px'; tooltip.style.display = 'block';
        tooltip.innerHTML = `M${p.monthIndex} • Principal $${p.cumPrincipal.toLocaleString()} • Interest $${p.cumInterest.toLocaleString()}`;
        const hoverG = svg.querySelector('g.mini-hover'); hoverG.innerHTML = '';
        const svgNS = 'http://www.w3.org/2000/svg';
        const stepX2 = (w - pad*2) / Math.max(1, fullSched.length -1);
        const iX = pad + idxNearest * stepX2;
        const ysP = pPoints.map(pp=>pp.y), ysI = iPoints.map(pp=>pp.y);
        const minP = Math.min(...ysP), maxP = Math.max(...ysP), rangeP = Math.max(1e-6,maxP-minP);
        const minI = Math.min(...ysI), maxI = Math.max(...ysI), rangeI = Math.max(1e-6,maxI-minI);
        const cyP = pad + (h - pad*2) - ((p.cumPrincipal - minP)/rangeP)*(h-pad*2);
        const cyI = pad + (h - pad*2) - ((p.cumInterest - minI)/rangeI)*(h-pad*2);
        const cP = document.createElementNS(svgNS,'circle'); cP.setAttribute('cx',iX); cP.setAttribute('cy',cyP); cP.setAttribute('r',3.6); cP.setAttribute('fill','#06b6d4'); cP.setAttribute('stroke','#fff'); cP.setAttribute('stroke-width','1'); hoverG.appendChild(cP);
        const cI = document.createElementNS(svgNS,'circle'); cI.setAttribute('cx',iX); cI.setAttribute('cy',cyI); cI.setAttribute('r',3.6); cI.setAttribute('fill','#a78bfa'); cI.setAttribute('stroke','#fff'); cI.setAttribute('stroke-width','1'); hoverG.appendChild(cI);
      });
      svg.addEventListener('mouseleave', ()=>{ tooltip.style.display='none'; const hoverG=svg.querySelector('g.mini-hover'); if(hoverG) hoverG.innerHTML=''; });
    });

    /* ============================
       Drawer helpers
       ============================ */
    const drawer = document.getElementById('drawer');
    const drawerTitle = document.getElementById('drawerTitle');
    const drawerSub = document.getElementById('drawerSub');
    const drawerPrimary = document.getElementById('drawerPrimary');
    const drawerSecondary = document.getElementById('drawerSecondary');
    const amortBody = document.getElementById('amortBody');
    const drawerChartArea = document.getElementById('drawerChartArea');
    const drawerLegend = document.getElementById('drawerLegend');
    const drawerExtra = document.getElementById('drawerExtra');
    let currentLoan = null, currentMode = null;

    function closeDrawer() { drawer.classList.remove('open'); drawer.setAttribute('aria-hidden','true'); tooltip.style.display='none'; currentLoan=null; currentMode=null; }

    document.getElementById('closeBtn').addEventListener('click', closeDrawer);
    document.addEventListener('keydown', (e)=>{ if(e.key==='Escape') closeDrawer(); });

    function openDrawerForLoan(loan) {
      currentMode='loan'; currentLoan=loan;
      drawerTitle.textContent = `Loan ${loan.id}`; drawerSub.textContent = `Purchased: ${loan.purchaseDate}`;
      document.getElementById('drawerPrimaryTitle').textContent = 'Purchase Price';
      document.getElementById('drawerSecondaryTitle').textContent = 'Rate';
      drawerPrimary.textContent = `$${loan.purchasePrice.toLocaleString()}`; drawerSecondary.textContent = `${(loan.nominalRate*100).toFixed(2)}%`;

      // amort table
      amortBody.innerHTML = '';
      loan.amort.schedule.forEach(r => {
        const tr = document.createElement('tr');
        tr.innerHTML = `<td style="text-align:left">${r.monthIndex}</td><td style="text-align:right">$${Number(r.payment).toFixed(2)}</td><td style="text-align:right">$${Number(r.principalPaid).toFixed(2)}</td><td style="text-align:right">$${Number(r.interest).toFixed(2)}</td><td style="text-align:right">$${Number(r.balance).toFixed(2)}</td>`;
        amortBody.appendChild(tr);
      });

      // chart (simple multi-line like before)
      drawerChartArea.innerHTML = ''; drawerLegend.style.display='flex';
      drawerLegend.innerHTML = `<div class="item"><span class="sw" style="background:#0f172a"></span>Balance</div><div class="item"><span class="sw" style="background:#06b6d4"></span>Cum Principal</div><div class="item"><span class="sw" style="background:#a78bfa"></span>Cum Interest</div><div class="item"><span class="sw" style="background:#fb7185"></span>Total</div>`;
      // build an svg similar to earlier implementation (kept compact for clarity)
      const svgNS = 'http://www.w3.org/2000/svg';
      const w = 680, h = 260, pad = 36;
      const svg = document.createElementNS(svgNS,'svg'); svg.setAttribute('viewBox',`0 0 ${w} ${h}`); svg.setAttribute('width','100%'); svg.setAttribute('height','100%');
      const schedule = loan.cumSchedule;
      const balances = loan.amort.schedule.map(s=>({x:s.monthIndex,y:s.balance}));
      const cumP = schedule.map(s=>({x:s.monthIndex,y:s.cumPrincipal}));
      const cumI = schedule.map(s=>({x:s.monthIndex,y:s.cumInterest}));
      const cumT = schedule.map(s=>({x:s.monthIndex,y:s.cumTotal}));
      const allYs = [...balances.map(p=>p.y),...cumP.map(p=>p.y),...cumI.map(p=>p.y),...cumT.map(p=>p.y)];
      const maxY = Math.max(...allYs), minY = Math.min(...allYs), range = Math.max(1e-6,maxY-minY);
      const stepX = (w - pad*2) / Math.max(1,schedule.length - 1);
      function toXY(point,i){ const x = pad + i*stepX; const y = pad + (h - pad*2) - ((point.y - minY)/range) * (h - pad*2); return [x,y]; }
      function buildPath(arr){ return arr.map((p,i)=>{ const [x,y]=toXY(p,i); return (i===0?('M '+x+' '+y):(' L '+x+' '+y)); }).join(' '); }

      // grid
      for(let gy=0;gy<4;gy++){ const y = pad + gy*((h - pad*2)/3); const ln = document.createElementNS(svgNS,'line'); ln.setAttribute('x1',pad); ln.setAttribute('x2',w-pad); ln.setAttribute('y1',y); ln.setAttribute('y2',y); ln.setAttribute('stroke','#eef2f7'); svg.appendChild(ln); }

      const pBal = buildPath(balances); const pP = buildPath(cumP); const pI = buildPath(cumI); const pT = buildPath(cumT);
      const elBal = document.createElementNS(svgNS,'path'); elBal.setAttribute('d',pBal); elBal.setAttribute('fill','none'); elBal.setAttribute('stroke','#0f172a'); elBal.setAttribute('stroke-width','2'); svg.appendChild(elBal);
      const elP = document.createElementNS(svgNS,'path'); elP.setAttribute('d',pP); elP.setAttribute('fill','none'); elP.setAttribute('stroke','#06b6d4'); elP.setAttribute('stroke-width','1.6'); svg.appendChild(elP);
      const elI = document.createElementNS(svgNS,'path'); elI.setAttribute('d',pI); elI.setAttribute('fill','none'); elI.setAttribute('stroke','#a78bfa'); elI.setAttribute('stroke-width','1.6'); svg.appendChild(elI);
      const elT = document.createElementNS(svgNS,'path'); elT.setAttribute('d',pT); elT.setAttribute('fill','none'); elT.setAttribute('stroke','#fb7185'); elT.setAttribute('stroke-width','1.4'); svg.appendChild(elT);

      // current marker
      const maxMonth = schedule.length; const curX = pad + (Math.max(1, Math.min(CURRENT_MONTH, maxMonth)) -1)*stepX;
      const curLine = document.createElementNS(svgNS,'line'); curLine.setAttribute('x1',curX); curLine.setAttribute('x2',curX); curLine.setAttribute('y1',pad); curLine.setAttribute('y2',h-pad); curLine.setAttribute('stroke','#111827'); curLine.setAttribute('stroke-dasharray','3 4'); curLine.setAttribute('stroke-opacity','0.6'); svg.appendChild(curLine);

      // hover
      const vLine = document.createElementNS(svgNS,'line'); vLine.setAttribute('stroke','#0f172a'); vLine.setAttribute('stroke-width','1'); vLine.setAttribute('stroke-dasharray','3 4'); vLine.setAttribute('opacity','0.6'); svg.appendChild(vLine);
      const circles = document.createElementNS(svgNS,'g'); svg.appendChild(circles);

      svg.addEventListener('mousemove', (ev)=>{ const rect=svg.getBoundingClientRect(); const x = ev.clientX - rect.left; let idx = Math.round((x - pad)/stepX); idx = Math.max(0, Math.min(schedule.length -1, idx)); const px = pad + idx*stepX; vLine.setAttribute('x1',px); vLine.setAttribute('x2',px); vLine.setAttribute('y1',pad); vLine.setAttribute('y2',h-pad); circles.innerHTML=''; const vals = { month: schedule[idx].monthIndex, balance: balances[idx].y, cumP: cumP[idx].y, cumI: cumI[idx].y, cumT: cumT[idx].y }; const series = [{val:vals.balance,color:'#0f172a'},{val:vals.cumP,color:'#06b6d4'},{val:vals.cumI,color:'#a78bfa'},{val:vals.cumT,color:'#fb7185'}]; series.forEach(s=>{ const [cx,cy]=toXY({y:s.val}, idx); const c = document.createElementNS(svgNS,'circle'); c.setAttribute('cx',cx); c.setAttribute('cy',cy); c.setAttribute('r',4); c.setAttribute('fill',s.color); c.setAttribute('stroke','#fff'); c.setAttribute('stroke-width','1.2'); circles.appendChild(c); }); tooltip.style.display='block'; tooltip.style.left = (rect.left + px) + 'px'; tooltip.style.top = (rect.top + 16) + 'px'; tooltip.innerHTML = `M${vals.month} — Balance $${vals.balance.toLocaleString()}<br>Principal $${vals.cumP.toLocaleString()} • Interest $${vals.cumI.toLocaleString()} • Total $${vals.cumT.toLocaleString()}`; });

      svg.addEventListener('mouseleave', ()=>{ vLine.setAttribute('x1',0); vLine.setAttribute('x2',0); circles.innerHTML=''; tooltip.style.display='none'; });

      drawerChartArea.appendChild(svg);
      drawer.classList.add('open'); drawer.setAttribute('aria-hidden','false'); drawer.scrollTop = 0;
    }

    /* ============================
       KPI drawers (basic implementations with charts)
       ============================ */
    function monthLabel(dateStr){ const d = new Date(dateStr + 'T00:00:00'); return d.toLocaleString(undefined, { year: 'numeric', month: 'short' }); }

    function renderDistributionDrawer(){
      currentMode='kpi'; currentLoan=null;
      drawerTitle.textContent='Distribution — Loans by Purchase Month'; drawerSub.textContent='Number of loans purchased by month';
      document.getElementById('drawerPrimaryTitle').textContent='Total Invested'; document.getElementById('drawerSecondaryTitle').textContent='Total Loans';
      const totals = {}; loansWithAmort.forEach(l=>{ const m=monthLabel(l.purchaseDate); totals[m]=(totals[m]||0)+l.purchasePrice; });
      const keys = Object.keys(totals); const vals = keys.map(k=>totals[k]); document.getElementById('drawerPrimary').textContent = '$' + (vals.reduce((a,b)=>a+b,0)).toLocaleString(); document.getElementById('drawerSecondary').textContent = loansWithAmort.length + ' loans';
      // simple bar chart
      drawerChartArea.innerHTML=''; drawerLegend.style.display='none';
      const svg = document.createElementNS('http://www.w3.org/2000/svg','svg'); const w=680,h=260,pad=36; svg.setAttribute('viewBox',`0 0 ${w} ${h}`); svg.setAttribute('width','100%'); svg.setAttribute('height','100%');
      const maxV = Math.max(...vals,1);
      keys.forEach((k,i)=>{ const barW = (w - pad*2)/keys.length * 0.7; const gap = ((w - pad*2)/keys.length - barW)/2; const x = pad + i*((w-pad*2)/keys.length) + gap; const barH = (vals[i]/maxV)*(h - pad*2); const y = h - pad - barH; const rect = document.createElementNS('http://www.w3.org/2000/svg','rect'); rect.setAttribute('x',x); rect.setAttribute('y',y); rect.setAttribute('width',barW); rect.setAttribute('height',barH); rect.setAttribute('fill','#06b6d4'); svg.appendChild(rect); const text = document.createElementNS('http://www.w3.org/2000/svg','text'); text.setAttribute('x',x+barW/2); text.setAttribute('y',h-pad+14); text.setAttribute('font-size','11'); text.setAttribute('text-anchor','middle'); text.setAttribute('fill','#475569'); text.textContent = k; svg.appendChild(text); rect.addEventListener('mousemove', (ev)=>{ tooltip.style.display='block'; tooltip.style.left = ev.clientX + 'px'; tooltip.style.top = (ev.clientY - 12) + 'px'; tooltip.innerHTML = `${k} • $${vals[i].toLocaleString()}`; }); rect.addEventListener('mouseleave', ()=>tooltip.style.display='none'); });
      drawerChartArea.appendChild(svg);
      drawerExtra.innerHTML = `<div style="margin-top:12px"><strong class="small">Loans</strong><div style="max-height:220px;overflow:auto;margin-top:6px;border-radius:6px;padding:6px;border:1px solid var(--border);background:var(--card)"><table style="width:100%"><thead><tr><th style="text-align:left">Loan</th><th style="text-align:left">Purchase</th><th>Amount</th><th>Rate</th></tr></thead><tbody>${loansWithAmort.map(l=>`<tr><td style="text-align:left">Loan ${l.id}</td><td>${l.purchaseDate}</td><td>$${l.purchasePrice.toLocaleString()}</td><td>${(l.nominalRate*100).toFixed(2)}%</td></tr>`).join('')}</tbody></table></div></div>`;
      drawer.classList.add('open'); drawer.setAttribute('aria-hidden','false');
    }

    function renderTPVDrawer(){
      currentMode='kpi'; currentLoan=null;
      drawerTitle.textContent='Portfolio Snapshot'; drawerSub.textContent='TPV (purchase + accrued + payments)';
      document.getElementById('drawerPrimaryTitle').textContent='TPV (current)'; document.getElementById('drawerSecondaryTitle').textContent='Total Invested';
      // simple TPV series (repurposed earlier logic)
      const maxMonths = Math.max(...loansWithAmort.map(l=>l.amort.schedule.length));
      const series = [];
      for(let m=1;m<=maxMonths;m++){ let total=0; loansWithAmort.forEach(l=>{ const accrued = l.amort.schedule.filter(s=>s.monthIndex<=m && s.payment===0).reduce((s,r)=>s+r.interest,0); const payments = l.amort.schedule.filter(s=>s.monthIndex<=m).reduce((s,r)=>s+r.payment,0); total += l.purchasePrice + accrued + payments; }); series.push({month:m,value:total}); }
      const cur = series[Math.min(CURRENT_MONTH-1, series.length-1)].value;
      document.getElementById('drawerPrimary').textContent = (Math.round(cur)).toLocaleString ? '$' + Math.round(cur).toLocaleString() : '$' + Math.round(cur);
      document.getElementById('drawerSecondary').textContent = '$' + loansWithAmort.reduce((s,l)=>s+l.purchasePrice,0).toLocaleString();
      // draw line
      drawerChartArea.innerHTML=''; const svg = document.createElementNS('http://www.w3.org/2000/svg','svg'); const w=680,h=260,pad=36; svg.setAttribute('viewBox',`0 0 ${w} ${h}`); svg.setAttribute('width','100%'); svg.setAttribute('height','100%');
      const vals = series.map(s=>s.value); const maxV = Math.max(...vals), minV = Math.min(...vals), range = Math.max(1e-6,maxV-minV); const stepX = (w - pad*2)/Math.max(1,series.length-1);
      let pts='';
      series.forEach((d,i)=>{ const x = pad + i*stepX; const y = pad + (h - pad*2) - ((d.value - minV)/range)*(h-pad*2); pts += `${x},${y} `; });
      const poly = document.createElementNS('http://www.w3.org/2000/svg','polyline'); poly.setAttribute('points',pts); poly.setAttribute('fill','none'); poly.setAttribute('stroke','#0ea5e9'); poly.setAttribute('stroke-width','2'); svg.appendChild(poly);
      // current marker
      const curIdx = Math.min(CURRENT_MONTH-1, series.length-1); const curX = pad + curIdx*stepX; const curLine = document.createElementNS('http://www.w3.org/2000/svg','line'); curLine.setAttribute('x1',curX); curLine.setAttribute('x2',curX); curLine.setAttribute('y1',pad); curLine.setAttribute('y2',h-pad); curLine.setAttribute('stroke','#111827'); curLine.setAttribute('stroke-dasharray','3 4'); curLine.setAttribute('stroke-opacity','0.6'); svg.appendChild(curLine);
      drawerChartArea.appendChild(svg);
      drawerExtra.innerHTML = `<div style="margin-top:12px"><strong class="small">TPV Snapshot</strong><div style="font-size:18px;font-weight:800;margin-top:6px">$${Math.round(cur).toLocaleString()}</div></div>`;
      drawer.classList.add('open'); drawer.setAttribute('aria-hidden','false');
    }

    function renderRatesDrawer(){
      currentMode='kpi'; currentLoan=null;
      drawerTitle.textContent='Rates Distribution'; drawerSub.textContent='Histogram of nominal rates';
      document.getElementById('drawerPrimaryTitle').textContent='Avg Rate'; document.getElementById('drawerPrimary').textContent = (kpis.weightedRate).toFixed(2)+'%'; document.getElementById('drawerSecondaryTitle').textContent='Total Loans'; document.getElementById('drawerSecondary').textContent = loansWithAmort.length;
      // histogram
      const rates = loansWithAmort.map(l=>l.nominalRate*100); drawerChartArea.innerHTML='';
      const svg = document.createElementNS('http://www.w3.org/2000/svg','svg'); const w=680,h=260,pad=36; svg.setAttribute('viewBox',`0 0 ${w} ${h}`); svg.setAttribute('width','100%'); svg.setAttribute('height','100%');
      const min = Math.min(...rates), max = Math.max(...rates), bins=6; const binSize = (max-min)/bins || 1; const counts = new Array(bins).fill(0); rates.forEach(r=>{ let idx = Math.floor((r-min)/binSize); if(idx===bins) idx=bins-1; counts[idx]++; });
      const labels = counts.map((_,i)=>`${(min + i*binSize).toFixed(1)}–${(min + (i+1)*binSize).toFixed(1)}`);
      const maxC = Math.max(...counts,1); const barW = (w - pad*2)/bins;
      counts.forEach((c,i)=>{ const x = pad + i*barW; const barH = (c/maxC)*(h - pad*2); const y = h - pad - barH; const rect = document.createElementNS('http://www.w3.org/2000/svg','rect'); rect.setAttribute('x',x+6); rect.setAttribute('y',y); rect.setAttribute('width',barW-12); rect.setAttribute('height',barH); rect.setAttribute('fill','#7c3aed'); svg.appendChild(rect); const text = document.createElementNS('http://www.w3.org/2000/svg','text'); text.setAttribute('x',x + barW/2); text.setAttribute('y',h-pad+14); text.setAttribute('font-size','11'); text.setAttribute('text-anchor','middle'); text.setAttribute('fill','#64748b'); text.textContent = labels[i]; svg.appendChild(text); rect.addEventListener('mousemove',(ev)=>{ tooltip.style.display='block'; tooltip.style.left = ev.clientX + 'px'; tooltip.style.top = (ev.clientY - 12) + 'px'; tooltip.innerHTML = `${c} loans`; }); rect.addEventListener('mouseleave',()=>tooltip.style.display='none'); });
      drawerChartArea.appendChild(svg);
      drawerExtra.innerHTML = `<div style="margin-top:12px" class="small">Rates range: ${(Math.min(...rates)).toFixed(2)}% — ${(Math.max(...rates)).toFixed(2)}%</div>`;
      drawer.classList.add('open'); drawer.setAttribute('aria-hidden','false');
    }

    function renderPaymentsDrawer(){
      currentMode='kpi'; currentLoan=null;
      drawerTitle.textContent='Monthly Expected Payments'; drawerSub.textContent='Sum of scheduled payments across loans';
      document.getElementById('drawerPrimaryTitle').textContent='Monthly Income'; document.getElementById('drawerPrimary').textContent = '$' + Math.round(kpis.monthlyIncome).toLocaleString(); document.getElementById('drawerSecondaryTitle').textContent='Total Invested'; document.getElementById('drawerSecondary').textContent = '$' + kpis.total.toLocaleString();
      // timeseries simple (months)
      drawerChartArea.innerHTML=''; const months = []; const payments = [];
      // use length of max schedule for x-axis
      const maxMonths = Math.max(...loansWithAmort.map(l=>l.amort.schedule.length));
      for(let m=1;m<=maxMonths;m++){ months.push('M'+m); let sum=0; loansWithAmort.forEach(l=>{ const idx = Math.min(l.amort.schedule.length-1, m-1); const e = l.amort.schedule[idx] || {payment:0}; sum += e.payment; }); payments.push(sum); }
      // draw polyline
      const svg = document.createElementNS('http://www.w3.org/2000/svg','svg'); const w=680,h=260,pad=36; svg.setAttribute('viewBox',`0 0 ${w} ${h}`); svg.setAttribute('width','100%'); svg.setAttribute('height','100%');
      const maxP = Math.max(...payments), minP = Math.min(...payments), range = Math.max(1e-6,maxP-minP); const stepX = (w - pad*2)/Math.max(1,payments.length-1);
      let pts=''; payments.forEach((p,i)=>{ const x = pad + i*stepX; const y = pad + (h - pad*2) - ((p - minP)/range) * (h - pad*2); pts += `${x},${y} `; });
      const poly = document.createElementNS('http://www.w3.org/2000/svg','polyline'); poly.setAttribute('points',pts); poly.setAttribute('fill','none'); poly.setAttribute('stroke','#fb7185'); poly.setAttribute('stroke-width','2'); svg.appendChild(poly);
      drawerChartArea.appendChild(svg);
      drawerExtra.innerHTML = `<div style="margin-top:12px" class="small">Monthly payments across portfolio</div>`;
      drawer.classList.add('open'); drawer.setAttribute('aria-hidden','false');
    }

    // wire KPI click events
    document.querySelectorAll('.kpi').forEach(k => { k.addEventListener('click', (ev) => { ev.stopPropagation(); const key = k.getAttribute('data-kpi'); if (key === 'distribution') renderDistributionDrawer(); if (key === 'tpv') renderTPVDrawer(); if (key === 'rates') renderRatesDrawer(); if (key === 'payments') renderPaymentsDrawer(); }); });

    // CSV & copy actions
    function amortToCSV(loan){ const rows=[['Month','Payment','Principal','Interest','Balance']]; loan.amort.schedule.forEach(r=>rows.push([r.monthIndex, r.payment.toFixed(2), r.principalPaid.toFixed(2), r.interest.toFixed(2), r.balance.toFixed(2)])); return rows.map(r=>r.join(',')).join('\n'); }
    document.getElementById('copyCsvBtn').addEventListener('click', async ()=>{ if(currentMode!=='loan' || !currentLoan) return alert('Open an individual loan drawer to copy CSV'); try{ await navigator.clipboard.writeText(amortToCSV(currentLoan)); alert('CSV copied to clipboard'); }catch(e){ alert('Clipboard write failed'); } });
    document.getElementById('downloadCsvBtn').addEventListener('click', ()=>{ if(currentMode==='loan' && currentLoan){ const csv = amortToCSV(currentLoan); const blob = new Blob([csv],{type:'text/csv'}); const url = URL.createObjectURL(blob); const a = document.createElement('a'); a.href=url; a.download=`loan-${currentLoan.id}-amort.csv`; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url); } else alert('Download CSV is supported for individual loan drawers only.'); });
    document.getElementById('downloadCsvBtnTop').addEventListener('click', ()=>{ let rows=[['Loan','Purchase Date','Amount','Rate']]; loansWithAmort.forEach(l=>rows.push([`Loan ${l.id}`, l.purchaseDate, l.purchasePrice, (l.nominalRate*100).toFixed(2)+'%'])); navigator.clipboard.writeText(rows.map(r=>r.join(',')).join('\n')); alert('Portfolio CSV copied to clipboard'); });

    document.getElementById('printBtn').addEventListener('click', ()=>window.print());

    // close drawer when clicking outside
    document.addEventListener('click', function (e) { if(!drawer.classList.contains('open')) return; const clickedInsideDrawer = drawer.contains(e.target); const clickedTile = !!e.target.closest('.tile'); if(!clickedInsideDrawer && !clickedTile) closeDrawer(); });

    // hide tooltip on grid scroll
    document.querySelector('.grid').addEventListener('scroll', ()=>tooltip.style.display='none');

    /* ============================
       Dark mode toggle (full theme)
       - store preference in localStorage
       - safe single declaration / event listener
       ============================ */
    const themeToggle = document.getElementById('themeToggle');
    const themeLabel = document.getElementById('themeLabel');
    const themeIcon = document.getElementById('themeIcon');

    function applyTheme(t) {
      if (t === 'dark') {
        document.documentElement.classList.add('dark');
        themeToggle.setAttribute('data-theme','dark');
        themeToggle.setAttribute('aria-pressed','true');
        themeLabel.textContent = 'Dark';
        themeIcon.style.background = 'var(--brand)';
      } else {
        document.documentElement.classList.remove('dark');
        themeToggle.setAttribute('data-theme','light');
        themeToggle.setAttribute('aria-pressed','false');
        themeLabel.textContent = 'Light';
        themeIcon.style.background = 'var(--brand)';
      }
      try { localStorage.setItem('lp_theme', t); } catch(e){}
    }

    // initialize from preference or system
    const stored = (function(){ try { return localStorage.getItem('lp_theme'); } catch(e){ return null; } })();
    if (stored) applyTheme(stored); else {
      // prefer system dark
      const prefersDark = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;
      applyTheme(prefersDark ? 'dark' : 'light');
    }

    themeToggle.addEventListener('click', (e)=>{ const next = document.documentElement.classList.contains('dark') ? 'light' : 'dark'; applyTheme(next); });

  }); // end DOMContentLoaded
  </script>
</body>
</html>
