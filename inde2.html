<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Loan Portfolio â€” Earnings</title>

  <style>
    :root {
      --bg-light:#f8fafc;
      --bg-dark:#0F172A;
      --card-light:#ffffff;
      --card-dark:#1E293B;
      --border-light:rgba(15,23,42,0.07);
      --border-dark:#334155;
      --text-light:#0f172a;
      --text-dark:#E2E8F0;
      --accent:#0ea5e9;
      --accent-2:#0ea5e933;
      --bg:#f8fafc;
      --card:#ffffff;
      --border:rgba(15,23,42,0.07);
      --text:#0f172a;
      --muted:#64748b;
      --brand:#0ea5e9;
      --accent2:#7c3aed;
      --surface:#f1f5f9;
      --surface-2:#e2e8f0;
      --shadow:0 12px 30px rgba(15,23,42,0.06);
      --kpi-hover:translateY(-6px);
      --chart-grid:#e2e8f0;
      --chart-axis:#94a3b8;
      --chart-bg:linear-gradient(180deg,var(--card),#fcfeff);
      --table-stripe:rgba(15,23,42,0.03);
      --tooltip-bg:#0f172a;
      --tooltip-text:#e2e8f0;
    }

    html { color-scheme:light; }

    html[data-theme="dark"] {
      color-scheme:dark;
      --bg:var(--bg-dark);
      --card:var(--card-dark);
      --border:var(--border-dark);
      --text:var(--text-dark);
      --muted:#9aa6b2;
      --surface:#020617;
      --surface-2:#0b1224;
      --shadow:0 12px 30px rgba(0,0,0,0.4);
      --chart-grid:#0f172a;
      --chart-axis:#cbd5e1;
      --chart-bg:linear-gradient(180deg,#0b1224,#0f172a);
      --table-stripe:rgba(148,163,184,0.08);
      --tooltip-bg:#0b1224;
      --tooltip-text:#e2e8f0;
    }

    body {
      margin:0;
      font-family:Inter,system-ui,-apple-system,"Segoe UI",Roboto,Arial;
      background:linear-gradient(180deg,var(--surface) 0%, var(--card) 100%);
      background-color:var(--bg);
      color:var(--text);
      -webkit-font-smoothing:antialiased;
      transition:background-color .25s ease, color .25s ease;
    }

    html[data-theme="dark"] body {
      background:linear-gradient(180deg,#0b1224 0%, #0f172a 100%);
    }

    .app {
      max-width:1200px;
      margin:20px auto;
      padding:16px;
      transition:color .25s ease;
    }

    header {
      display:flex;
      flex-direction:column;
      gap:8px;
      margin-bottom:12px;
      transition:color .25s ease;
    }
    .header-top {
      display:flex;
      align-items:center;
      justify-content:space-between;
    }
    h1 {
      font-size:20px;
      margin:0;
    }
    p.lead {
      margin:0;
      color:var(--muted);
      font-size:13px;
    }
    .current-date {
      font-size:13px;
      color:var(--muted);
      margin-top:4px;
    }

    .actions { display:flex; gap:8px; align-items:center }
    .btn{
      padding:8px 12px;
      border-radius:8px;
      border:1px solid rgba(15,23,42,0.06);
      background:transparent;
      cursor:pointer;
      font-weight:600;
    }
    .btn.primary{
      background:linear-gradient(90deg,var(--brand),var(--accent2));
      color:white;
      border:none;
      box-shadow:var(--shadow);
    }
    .close-btn{
      background:#f1f5f9;
      border:none;
      padding:8px;
      border-radius:8px;
      cursor:pointer;
    }

    .kpis{
      display:grid;
      grid-template-columns:repeat(4,1fr);
      gap:12px;
      margin:14px 0 18px;
    }
    .kpi{
      background:var(--card);
      padding:14px;
      border-radius:12px;
      box-shadow:0 6px 18px rgba(16,24,40,0.04);
      border:1px solid var(--border);
      cursor:pointer;
      transition:transform .18s ease, box-shadow .18s ease, background-color .25s ease, border-color .25s ease, color .25s ease;
      display:flex;
      flex-direction:column;
      justify-content:center;
    }
    .kpi h3{
      margin:0;
      font-size:12px;
      color:var(--muted);
    }
    .kpi p{
      margin:8px 0 0;
      font-size:18px;
      font-weight:700;
    }
    .kpi:hover { transform:var(--kpi-hover); box-shadow:var(--shadow); }

    .grid{
      display:grid;
      grid-template-columns:repeat(2,1fr);
      gap:12px;
      height:calc(100vh - 320px);
      overflow:auto;
      padding-right:6px;
    }
    @media(max-width:900px){
      .grid{ grid-template-columns:1fr; height:auto; }
      .kpis{ grid-template-columns:repeat(2,1fr); }
    }

    .tile{
      display:flex;
      align-items:center;
      justify-content:space-between;
      padding:12px;
      border-radius:12px;
      background:var(--card);
      min-height:110px;
      cursor:pointer;
      overflow:hidden;
      transition:transform .18s ease, box-shadow .18s ease, background-color .25s ease, border-color .25s ease, color .25s ease;
      border:1px solid var(--border);
    }
    .tile:hover{ transform:var(--kpi-hover); box-shadow:var(--shadow); }
    .tile-left{ flex:1; padding-right:10px; }
    .loan-name{ font-weight:700; font-size:14px; }
    .loan-sub{ font-size:12px; color:var(--muted); margin-top:6px; }
    .loan-meta{ display:flex; gap:8px; font-size:12px; color:var(--muted); margin-top:8px; }

    .chart-wrap{
      width:170px;
      flex-shrink:0;
      display:flex;
      flex-direction:column;
      align-items:flex-end;
    }
    .mini-label{
      font-size:12px;
      color:var(--muted);
      margin-bottom:6px;
      text-align:right;
      width:100%;
    }

    /* Drawer */
    .drawer{
      position:fixed;
      right:0;
      top:0;
      height:100vh;
      max-width:1000px;
      width:760px;
      background:var(--card);
      box-shadow:-28px 0 80px rgba(2,6,23,0.14);
      transform:translateX(110%);
      transition:transform .32s cubic-bezier(.2,.9,.3,1), opacity .24s ease, background-color .25s ease, border-color .25s ease, box-shadow .25s ease;
      z-index:120;
      overflow:auto;
      padding:20px;
      opacity:0;
    }
    .drawer.open{
      transform:translateX(0);
      opacity:1;
      animation:drawerIn .28s cubic-bezier(.2,.9,.3,1);
    }
    @keyframes drawerIn {
      from { transform:translateX(30%); opacity:0; }
      to   { transform:translateX(0);   opacity:1; }
    }

    .drawer-head{
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:8px;
      margin-bottom:12px;
    }
    .drawer-chart{
      width:100%;
      height:260px;
      background:var(--chart-bg);
      border-radius:8px;
      border:1px solid rgba(15,23,42,0.03);
      margin-bottom:8px;
      padding:0;
      position:relative;
      display:block;
      transition:background-color .25s ease, border-color .25s ease, box-shadow .25s ease;
    }

    .drawer-info-row{
      display:flex;
      gap:12px;
      margin-bottom:8px;
      align-items:center;
    }
    .info-card{
      flex:1;
      background:var(--bg);
      padding:12px;
      border-radius:8px;
      display:flex;
      flex-direction:column;
      justify-content:center;
      min-height:56px;
      transition:background-color .25s ease, color .25s ease, border-color .25s ease, box-shadow .25s ease;
    }
    .info-card.small{ width:160px; align-items:flex-end; }
    .muted-small{ font-size:12px; color:var(--muted); margin-bottom:6px; }
    .main-val{ font-weight:800; font-size:18px; }

    .amort-wrap{
      border:1px solid rgba(15,23,42,0.06);
      border-radius:8px;
      padding:8px;
      max-height:40vh;
      overflow:auto;
      background:var(--card);
      transition:background-color .25s ease, color .25s ease, border-color .25s ease;
    }

    table{ width:100%; border-collapse:collapse; font-size:13px; background:var(--card); border-radius:8px; overflow:hidden; border:1px solid var(--border); transition:background-color .25s ease, color .25s ease, border-color .25s ease; }
    thead th{
      position:sticky;
      top:0;
      background:var(--surface);
      padding:8px;
      text-align:left;
      color:var(--muted);
      font-weight:700;
      border-bottom:1px solid rgba(15,23,42,0.06);
      transition:background-color .25s ease, color .25s ease, border-color .25s ease;
    }
    td{
      padding:8px;
      border-bottom:1px dashed rgba(15,23,42,0.06);
      text-align:right;
      transition:background-color .25s ease, color .25s ease, border-color .25s ease;
    }
    tbody tr:nth-child(even){ background:var(--table-stripe); }
    tbody tr:hover{ background:rgba(14,165,233,0.08); }
    td:first-child, th:first-child{ text-align:left; }

    .tooltip{
      position:fixed;
      pointer-events:none;
      background:var(--tooltip-bg);
      color:var(--tooltip-text);
      padding:6px 8px;
      border-radius:6px;
      font-size:12px;
      transform:translate(-50%,-120%);
      box-shadow:0 6px 18px rgba(2,6,23,0.2);
      display:none;
      z-index:9999;
      line-height:1.12;
      border:1px solid rgba(148,163,184,0.3);
      transition:background-color .25s ease, color .25s ease, border-color .25s ease, box-shadow .25s ease;
    }
    .small{ font-size:12px; color:var(--muted); }

    @media(max-width:760px){
      .drawer{ width:100%; min-width:0; }
    }

    /* Theme toggle */
    .theme-icon{
      background:none;
      border:none;
      font-size:20px;
      cursor:pointer;
      transition:opacity .2s;
    }
    .theme-icon:hover{ opacity:0.7; }

    /* Dark mode overrides */
    html[data-theme="dark"] .kpi,
    html[data-theme="dark"] .tile,
    html[data-theme="dark"] .drawer-section,
    html[data-theme="dark"] .amort-wrap,
    html[data-theme="dark"] .info-card{
      background:var(--card);
      border-color:var(--border);
      box-shadow:0 10px 30px rgba(0,0,0,0.35);
    }
    html[data-theme="dark"] .kpi h3,
    html[data-theme="dark"] .loan-sub,
    html[data-theme="dark"] .loan-meta,
    html[data-theme="dark"] .muted-small{ color:var(--muted); }
    html[data-theme="dark"] .drawer{ box-shadow:-28px 0 80px rgba(0,0,0,0.45); border-left:1px solid var(--border); }
    html[data-theme="dark"] .drawer-chart{ border-color:rgba(148,163,184,0.25); box-shadow:0 10px 30px rgba(0,0,0,0.3); }
    html[data-theme="dark"] .drawer-table thead{ background:var(--surface-2); }
    html[data-theme="dark"] .drawer-table tbody tr:nth-child(even){ background:var(--table-stripe); }
    html[data-theme="dark"] table{ border-color:var(--border); }
    html[data-theme="dark"] thead th{ background:var(--surface-2); border-bottom:1px solid rgba(148,163,184,0.25); color:var(--text); }
    html[data-theme="dark"] td{ border-bottom:1px dashed rgba(148,163,184,0.24); }
    html[data-theme="dark"] tbody tr:nth-child(even){ background:var(--table-stripe); }
    html[data-theme="dark"] .tooltip{ background:var(--tooltip-bg); color:var(--tooltip-text); box-shadow:0 12px 30px rgba(0,0,0,0.45); border-color:rgba(148,163,184,0.35); }
    svg text{ fill:var(--text); transition:fill .25s ease; }

  </style>
</head>
<body>
  <div class="app" role="main">
    <header>
      <div class="header-top">
        <div>
          <h1>Loan Portfolio â€” Earnings</h1>
          <p class="lead">Cumulative principal, interest, and fees, with stacked earnings visuals.</p>
          <div class="current-date">
            Current Month Index: <strong id="currentMonthLabel">18</strong>
          </div>
        </div>
        <div style="display:flex; gap:10px; align-items:center;">
          <div style="font-size:13px; color:var(--muted)">
            User: <strong style="color:var(--brand)">Jeff L Customer</strong>
          </div>
          <button id="themeToggle" class="theme-icon" title="Toggle dark mode">ðŸŒ™</button>
        </div>
      </div>
    </header>

    <section class="kpis" id="kpis"></section>
    <section class="grid" id="loanGrid" aria-live="polite"></section>
  </div>

  <!-- Drawer -->
  <aside id="drawer" class="drawer" aria-hidden="true">
    <div class="drawer-head">
      <div>
        <h2 id="drawerTitle">Earnings Drawer</h2>
        <div class="muted-small" id="drawerSub">details</div>
      </div>
      <div style="display:flex;gap:8px;align-items:center">
        <button class="close-btn" id="closeBtn" aria-label="Close drawer">âœ•</button>
      </div>
    </div>

    <div class="drawer-info-row">
      <div class="info-card" id="drawerPrimaryCard">
        <div class="muted-small" id="drawerPrimaryTitle">Net Earnings</div>
        <div id="drawerPrimary" class="main-val"></div>
      </div>
      <div class="info-card small" id="drawerSecondaryCard">
        <div class="muted-small" id="drawerSecondaryTitle">Total Fees</div>
        <div id="drawerSecondary" class="main-val small"></div>
      </div>
    </div>

    <div id="drawerBody">
      <div class="drawer-chart" id="drawerChartArea"></div>
      <div id="drawerExtra"></div>
    </div>
  </aside>

  <div id="tooltip" class="tooltip" role="status" aria-live="polite"></div>

  <script>
    // --------------------------
    // Settings & base data
    // --------------------------
    const CURRENT_MONTH = 18; // keep in sync with ROI page if you want
    document.getElementById("currentMonthLabel").textContent = CURRENT_MONTH;

    // Loan metadata: same as ROI, with feePerMonth added.
    // TODO: Update feePerMonth values from Earnings.xlsx N1:T11 (col T).
    const loans = [
      { id:1,  purchaseDate:'2024-01-01', purchasePrice:7000,  termYears:10, graceYears:0.83, nominalRate:0.0883, feePerMonth:3.00 },
      { id:2,  purchaseDate:'2024-02-01', purchasePrice:7500,  termYears:8,  graceYears:2.00, nominalRate:0.0750, feePerMonth:3.00 },
      { id:3,  purchaseDate:'2024-03-01', purchasePrice:12000, termYears:12, graceYears:3.00, nominalRate:0.0825, feePerMonth:3.00 },
      { id:4,  purchaseDate:'2024-04-01', purchasePrice:6000,  termYears:9,  graceYears:1.50, nominalRate:0.0950, feePerMonth:3.00 },
      { id:5,  purchaseDate:'2024-07-01', purchasePrice:5000,  termYears:10, graceYears:1.00, nominalRate:0.0900, feePerMonth:3.00 },
      { id:6,  purchaseDate:'2025-01-01', purchasePrice:7500,  termYears:5,  graceYears:0.00, nominalRate:0.0730, feePerMonth:3.00 },
      { id:7,  purchaseDate:'2025-06-01', purchasePrice:10000, termYears:8,  graceYears:0.00, nominalRate:0.0900, feePerMonth:3.00 },
      { id:8,  purchaseDate:'2025-10-01', purchasePrice:5000,  termYears:9,  graceYears:0.50, nominalRate:0.1100, feePerMonth:3.00 },
      { id:9,  purchaseDate:'2025-02-01', purchasePrice:10000, termYears:7,  graceYears:0.25, nominalRate:0.1000, feePerMonth:3.00 },
      { id:10, purchaseDate:'2025-03-01', purchasePrice:8000,  termYears:3,  graceYears:0.00, nominalRate:0.0600, feePerMonth:3.00 }
    ];

    // --------------------------
    // Amortization + earnings
    // --------------------------
    function calcAmort(principal, annualRate, termYears, graceYears){
      const monthlyRate = annualRate / 12;
      const totalMonths = Math.round(termYears * 12);
      const graceMonths = Math.round(graceYears * 12);
      const repayMonths = Math.max(1, totalMonths - graceMonths);
      let balance = principal;
      const schedule = [];

      // grace period: interest only
      for(let m=1; m<=graceMonths; m++){
        const interest = +(balance * monthlyRate).toFixed(2);
        balance = +(balance + interest).toFixed(2);
        schedule.push({
          monthIndex:m,
          payment:0,
          principalPaid:0,
          interest,
          balance
        });
      }

      // repayment period
      const payment = monthlyRate === 0
        ? +(balance / repayMonths).toFixed(2)
        : +((balance * monthlyRate) / (1 - Math.pow(1+monthlyRate, -repayMonths))).toFixed(2);

      for(let m=1; m<=repayMonths; m++){
        const interest = +(balance * monthlyRate).toFixed(2);
        const principalPaid = +Math.min(balance, +(payment - interest).toFixed(2));
        balance = +(Math.max(0, balance - principalPaid).toFixed(2));
        schedule.push({
          monthIndex: graceMonths + m,
          payment:+payment.toFixed(2),
          principalPaid,
          interest,
          balance
        });
      }
      return { payment, schedule };
    }

    const loansWithEarnings = loans.map(l => {
      const amort = calcAmort(l.purchasePrice, l.nominalRate, l.termYears, l.graceYears);
      let cumP = 0, cumI = 0;
      const earningsSchedule = amort.schedule.map(row => {
        cumP = +(cumP + row.principalPaid).toFixed(2);
        cumI = +(cumI + row.interest).toFixed(2);
        const m = row.monthIndex;
        const cumFees = +(l.feePerMonth * m).toFixed(2);  // cumulative flat monthly fees
        const netEarnings = +(cumP + cumI - cumFees).toFixed(2);
        return {
          monthIndex:m,
          payment:row.payment,
          principalPaid:row.principalPaid,
          interest:row.interest,
          balance:row.balance,
          cumPrincipal:cumP,
          cumInterest:cumI,
          cumFees:cumFees,
          netEarnings:netEarnings
        };
      });
      return { ...l, amort, earningsSchedule };
    });

    // --------------------------
    // KPI calculations
    // --------------------------
    function computeEarningsKPIs(list){
      let totalNetToDate = 0;
      let totalNetProjected = 0;
      let totalFeesToDate = 0;
      let totalPrincipal = 0;

      list.forEach(l => {
        const lastIdx = l.earningsSchedule.length - 1;
        const atCurrent = l.earningsSchedule[Math.min(CURRENT_MONTH-1, lastIdx)] || l.earningsSchedule[lastIdx];
        const atEnd = l.earningsSchedule[lastIdx];

        totalNetToDate += atCurrent.netEarnings;
        totalFeesToDate += atCurrent.cumFees;
        totalNetProjected += atEnd.netEarnings;
        totalPrincipal += l.purchasePrice;
      });

      const avgMonthlyEarnings = CURRENT_MONTH > 0 ? totalNetToDate / CURRENT_MONTH : 0;

      return {
        totalNetToDate,
        totalNetProjected,
        totalFeesToDate,
        avgMonthlyEarnings
      };
    }

    const kpis = computeEarningsKPIs(loansWithEarnings);

    // --------------------------
    // Mini stacked earnings chart (per tile)
    // --------------------------
    function createMiniStackedEarningsSVG(containerEl, earningsSchedule){
      containerEl.innerHTML = "";
      const svgNS = "http://www.w3.org/2000/svg";
      const w = 170;
      const h = 48;
      const padL = 4, padR = 4, padT = 4, padB = 4;

      const data = earningsSchedule; // full life of loan

      // compute pos/neg ranges
      let maxAbs = 0;
      data.forEach(d => {
        const pos = d.cumPrincipal + d.cumInterest;
        const neg = -d.cumFees; // negative
        maxAbs = Math.max(maxAbs, pos, Math.abs(neg));
      });
      if(maxAbs <= 0) maxAbs = 1;

      const yZero = h/2;
      const halfHeight = (h - padT - padB) / 2;
      const scale = halfHeight / maxAbs;

      const count = data.length;
      const barW = (w - padL - padR) / Math.max(1, count);

      const axisColor = "var(--chart-axis)";

      const svg = document.createElementNS(svgNS,"svg");
      svg.setAttribute("viewBox", `0 0 ${w} ${h}`);
      svg.setAttribute("width","100%");
      svg.setAttribute("height","48");

      // zero axis
      const axis = document.createElementNS(svgNS,"line");
      axis.setAttribute("x1",padL);
      axis.setAttribute("x2",w-padR);
      axis.setAttribute("y1",yZero);
      axis.setAttribute("y2",yZero);
      axis.setAttribute("stroke",axisColor);
      axis.setAttribute("stroke-width","0.8");
      svg.appendChild(axis);

      data.forEach((d, i) => {
        const x = padL + i*barW;

        const principal = d.cumPrincipal;
        const interest = d.cumInterest;
        const fees = d.cumFees; // positive number, draw negative

        const posTotal = principal + interest;
        const negTotal = fees;

        const hPrin = principal * scale;
        const hInt  = interest  * scale;
        const hFees = negTotal  * scale;

        const yInt  = yZero - hInt;
        const yPrin = yZero - hInt - hPrin;
        const yFee  = yZero;

        // principal (top)
        const rPrin = document.createElementNS(svgNS,"rect");
        rPrin.setAttribute("x", x+1);
        rPrin.setAttribute("y", yPrin);
        rPrin.setAttribute("width", Math.max(1, barW-2));
        rPrin.setAttribute("height", hPrin);
        rPrin.setAttribute("fill", "#0ea5e9");

        // interest (middle)
        const rInt = document.createElementNS(svgNS,"rect");
        rInt.setAttribute("x", x+1);
        rInt.setAttribute("y", yInt);
        rInt.setAttribute("width", Math.max(1, barW-2));
        rInt.setAttribute("height", hInt);
        rInt.setAttribute("fill", "#22c55e");

        // fees (negative)
        const rFee = document.createElementNS(svgNS,"rect");
        rFee.setAttribute("x", x+1);
        rFee.setAttribute("y", yFee);
        rFee.setAttribute("width", Math.max(1, barW-2));
        rFee.setAttribute("height", hFees);
        rFee.setAttribute("fill", "#ef4444");

        svg.appendChild(rPrin);
        svg.appendChild(rInt);
        svg.appendChild(rFee);
      });

      containerEl.appendChild(svg);
    }

    // --------------------------
    // Drawer stacked chart (larger)
    // --------------------------
    function createDrawerStackedChart(containerEl, earningsSchedule){
      containerEl.innerHTML = "";
      const svgNS = "http://www.w3.org/2000/svg";
      const rect = containerEl.getBoundingClientRect();
      const w = Math.max(360, rect.width || 700);
      const h = 260;
      const padL = 50, padR = 20, padT = 20, padB = 40;

      const data = earningsSchedule;

      // find extrema
      let maxAbs = 0;
      data.forEach(d => {
        const pos = d.cumPrincipal + d.cumInterest;
        const neg = -d.cumFees;
        maxAbs = Math.max(maxAbs, pos, Math.abs(neg));
      });
      if(maxAbs <= 0) maxAbs = 1;

      const yZero = padT + (h - padT - padB) / 2;
      const halfHeight = (h - padT - padB) / 2;
      const scale = halfHeight / maxAbs;

      const count = data.length;
      const barW = (w - padL - padR) / Math.max(1, count);

      const axisColor = "var(--chart-axis)";
      const gridColor = "var(--chart-grid)";

      const svg = document.createElementNS(svgNS,"svg");
      svg.setAttribute("viewBox", `0 0 ${w} ${h}`);
      svg.setAttribute("width","100%");
      svg.setAttribute("height","100%");

      // grid lines / labels
      for(let i=0;i<=4;i++){
        const v = maxAbs * (1 - i/4);
        const yUp = yZero - v*scale;
        const yDn = yZero + v*scale;

        const upLine = document.createElementNS(svgNS,"line");
        upLine.setAttribute("x1",padL);
        upLine.setAttribute("x2",w-padR);
        upLine.setAttribute("y1",yUp);
        upLine.setAttribute("y2",yUp);
        upLine.setAttribute("stroke",gridColor);
        upLine.setAttribute("stroke-opacity","0.7");
        upLine.setAttribute("stroke-width","0.7");
        svg.appendChild(upLine);

        const dnLine = document.createElementNS(svgNS,"line");
        dnLine.setAttribute("x1",padL);
        dnLine.setAttribute("x2",w-padR);
        dnLine.setAttribute("y1",yDn);
        dnLine.setAttribute("y2",yDn);
        dnLine.setAttribute("stroke",gridColor);
        dnLine.setAttribute("stroke-opacity","0.45");
        dnLine.setAttribute("stroke-width","0.7");
        svg.appendChild(dnLine);

        const lbl = document.createElementNS(svgNS,"text");
        lbl.textContent = "$" + Math.round(v).toLocaleString();
        lbl.setAttribute("x", padL - 10);
        lbl.setAttribute("y", yUp + 4);
        lbl.setAttribute("font-size","11");
        lbl.setAttribute("fill","var(--text)");
        lbl.setAttribute("text-anchor","end");
        svg.appendChild(lbl);
      }

      // zero axis
      const axis = document.createElementNS(svgNS,"line");
      axis.setAttribute("x1",padL);
      axis.setAttribute("x2",w-padR);
      axis.setAttribute("y1",yZero);
      axis.setAttribute("y2",yZero);
      axis.setAttribute("stroke",axisColor);
      axis.setAttribute("stroke-width","1");
      svg.appendChild(axis);

      const tooltipEl = document.getElementById("tooltip");

      const hoverG = document.createElementNS(svgNS,"g");
      svg.appendChild(hoverG);

      data.forEach((d, i) => {
        const x = padL + i*barW;

        const principal = d.cumPrincipal;
        const interest = d.cumInterest;
        const fees = d.cumFees;

        const hPrin = principal * scale;
        const hInt  = interest  * scale;
        const hFees = fees      * scale;

        const yInt  = yZero - hInt;
        const yPrin = yZero - hInt - hPrin;
        const yFee  = yZero;

        const barWidth = Math.max(2, barW-4);

        const rPrin = document.createElementNS(svgNS,"rect");
        rPrin.setAttribute("x", x+2);
        rPrin.setAttribute("y", yPrin);
        rPrin.setAttribute("width", barWidth);
        rPrin.setAttribute("height", hPrin);
        rPrin.setAttribute("fill","#0ea5e9");

        const rInt = document.createElementNS(svgNS,"rect");
        rInt.setAttribute("x", x+2);
        rInt.setAttribute("y", yInt);
        rInt.setAttribute("width", barWidth);
        rInt.setAttribute("height", hInt);
        rInt.setAttribute("fill","#22c55e");

        const rFee = document.createElementNS(svgNS,"rect");
        rFee.setAttribute("x", x+2);
        rFee.setAttribute("y", yFee);
        rFee.setAttribute("width", barWidth);
        rFee.setAttribute("height", hFees);
        rFee.setAttribute("fill","#ef4444");

        // simple hover tooltip
        [rPrin,rInt,rFee].forEach(el=>{
          el.addEventListener("mousemove", ev=>{
            hoverG.innerHTML = "";
            const rectSvg = svg.getBoundingClientRect();
            const cx = ev.clientX - rectSvg.left;
            const cy = ev.clientY - rectSvg.top;

            const tipBg = document.createElementNS(svgNS,"rect");
            tipBg.setAttribute("x", cx - 70);
            tipBg.setAttribute("y", cy - 46);
            tipBg.setAttribute("width", 140);
            tipBg.setAttribute("height", 40);
            tipBg.setAttribute("rx", 6);
            tipBg.setAttribute("fill","black");
            tipBg.setAttribute("opacity","0.83");

            const tipText1 = document.createElementNS(svgNS,"text");
            tipText1.setAttribute("x", cx);
            tipText1.setAttribute("y", cy - 30);
            tipText1.setAttribute("fill","white");
            tipText1.setAttribute("font-size","11");
            tipText1.setAttribute("text-anchor","middle");
            tipText1.textContent = `M${d.monthIndex} Net: $${d.netEarnings.toFixed(2)}`;

            const tipText2 = document.createElementNS(svgNS,"text");
            tipText2.setAttribute("x", cx);
            tipText2.setAttribute("y", cy - 16);
            tipText2.setAttribute("fill","white");
            tipText2.setAttribute("font-size","10");
            tipText2.setAttribute("text-anchor","middle");
            tipText2.textContent = `P:$${d.cumPrincipal.toFixed(0)} I:$${d.cumInterest.toFixed(0)} F:-$${d.cumFees.toFixed(0)}`;

            hoverG.appendChild(tipBg);
            hoverG.appendChild(tipText1);
            hoverG.appendChild(tipText2);

            tooltipEl.style.display = "none"; // using inline tooltip
          });

          el.addEventListener("mouseleave", ()=>{
            hoverG.innerHTML = "";
          });
        });

        svg.appendChild(rPrin);
        svg.appendChild(rInt);
        svg.appendChild(rFee);

        // x-axis labels (every 12 months)
        if((d.monthIndex % 12) === 0 || d.monthIndex === 1){
          const lbl = document.createElementNS(svgNS,"text");
          lbl.textContent = "M"+d.monthIndex;
          lbl.setAttribute("x", x+barWidth/2);
          lbl.setAttribute("y", h-padB+16);
          lbl.setAttribute("font-size","11");
          lbl.setAttribute("fill","var(--text)");
          lbl.setAttribute("text-anchor","middle");
          svg.appendChild(lbl);
        }
      });

      containerEl.appendChild(svg);
    }

    // --------------------------
    // Render KPI tiles
    // --------------------------
    const kpisEl = document.getElementById("kpis");
    kpisEl.innerHTML = `
      <div class="kpi" data-kpi="netToDate">
        <h3>Total Net Earnings to Date</h3>
        <p id="kpiNetToDate">$${kpis.totalNetToDate.toLocaleString(undefined,{maximumFractionDigits:0})}</p>
      </div>
      <div class="kpi" data-kpi="projected">
        <h3>Projected Lifetime Earnings</h3>
        <p id="kpiNetProj">$${kpis.totalNetProjected.toLocaleString(undefined,{maximumFractionDigits:0})}</p>
      </div>
      <div class="kpi" data-kpi="avgMonthly">
        <h3>Average Monthly Earnings</h3>
        <p id="kpiAvgMonth">$${kpis.avgMonthlyEarnings.toFixed(2)}</p>
      </div>
      <div class="kpi" data-kpi="fees">
        <h3>Total Fees to Date</h3>
        <p id="kpiFees">$${kpis.totalFeesToDate.toLocaleString(undefined,{maximumFractionDigits:0})}</p>
      </div>
    `;

    // --------------------------
    // Loan tiles
    // --------------------------
    const grid = document.getElementById("loanGrid");
    const drawer = document.getElementById("drawer");
    const drawerTitle = document.getElementById("drawerTitle");
    const drawerSub = document.getElementById("drawerSub");
    const drawerPrimaryTitle = document.getElementById("drawerPrimaryTitle");
    const drawerPrimary = document.getElementById("drawerPrimary");
    const drawerSecondaryTitle = document.getElementById("drawerSecondaryTitle");
    const drawerSecondary = document.getElementById("drawerSecondary");
    const drawerChartArea = document.getElementById("drawerChartArea");
    const drawerExtra = document.getElementById("drawerExtra");

    let currentLoan = null;

    loansWithEarnings.forEach(loan => {
      const lastIdx = loan.earningsSchedule.length - 1;
      const atCurrent = loan.earningsSchedule[Math.min(CURRENT_MONTH-1, lastIdx)] || loan.earningsSchedule[lastIdx];

      const tile = document.createElement("div");
      tile.className = "tile";
      tile.setAttribute("tabindex","0");
      tile.innerHTML = `
        <div class="tile-left">
          <div class="loan-name">Loan ${loan.id}</div>
          <div class="loan-sub">$${loan.purchasePrice.toLocaleString()}</div>
          <div class="loan-meta">
            <div>Term: ${loan.termYears}y</div>
            <div>Grace: ${loan.graceYears}y</div>
            <div>Fee: $${loan.feePerMonth.toFixed(2)}/mo</div>
          </div>
        </div>
        <div class="chart-wrap">
          <div class="mini-label">
            Net Earnings M${CURRENT_MONTH}: $${atCurrent.netEarnings.toFixed(0)}
          </div>
          <div class="mini-chart"></div>
        </div>
      `;

      tile.addEventListener("click", e => {
        e.stopPropagation();
        openLoanDrawer(loan);
      });
      tile.addEventListener("keydown", e => {
        if(e.key === "Enter" || e.key === " "){
          e.preventDefault();
          openLoanDrawer(loan);
        }
      });

      grid.appendChild(tile);

      const miniChartContainer = tile.querySelector(".mini-chart");
      createMiniStackedEarningsSVG(miniChartContainer, loan.earningsSchedule);
    });

    // --------------------------
    // Drawer behavior
    // --------------------------
    document.getElementById("closeBtn").addEventListener("click", closeDrawer);
    document.addEventListener("keydown", e => {
      if(e.key === "Escape") closeDrawer();
    });
    document.addEventListener("click", e => {
      if(drawer.classList.contains("open")){
        const inside = drawer.contains(e.target);
        const tileClicked = e.target.closest(".tile");
        if(!inside && !tileClicked){
          closeDrawer();
        }
      }
    });

    function closeDrawer(){
      drawer.classList.remove("open");
      drawer.setAttribute("aria-hidden","true");
      currentLoan = null;
    }

    function openLoanDrawer(loan){
      currentLoan = loan;
      const lastIdx = loan.earningsSchedule.length - 1;
      const atCurrent = loan.earningsSchedule[Math.min(CURRENT_MONTH-1, lastIdx)] || loan.earningsSchedule[lastIdx];
      const atEnd = loan.earningsSchedule[lastIdx];

      drawerTitle.textContent = `Loan ${loan.id} â€” Earnings`;
      drawerSub.textContent = `Purchase: ${loan.purchaseDate} â€¢ Principal $${loan.purchasePrice.toLocaleString()}`;
      drawerPrimaryTitle.textContent = "Net Earnings to Date";
      drawerPrimary.textContent = `$${atCurrent.netEarnings.toFixed(2)}`;
      drawerSecondaryTitle.textContent = "Fees to Date";
      drawerSecondary.textContent = `$${atCurrent.cumFees.toFixed(2)}`;

      createDrawerStackedChart(drawerChartArea, loan.earningsSchedule);

      // table
      let rowsHtml = "";
      loan.earningsSchedule.forEach(r => {
        rowsHtml += `
          <tr>
            <td>${r.monthIndex}</td>
            <td>$${r.cumPrincipal.toFixed(2)}</td>
            <td>$${r.cumInterest.toFixed(2)}</td>
            <td>-$${r.cumFees.toFixed(2)}</td>
            <td>$${r.netEarnings.toFixed(2)}</td>
          </tr>
        `;
      });

      drawerExtra.innerHTML = `
        <h3 style="margin-top:12px;margin-bottom:8px;">Earnings Breakdown by Month</h3>
        <div class="amort-wrap">
          <table>
            <thead>
              <tr>
                <th>Month</th>
                <th>Cumulative Principal</th>
                <th>Cumulative Interest</th>
                <th>Cumulative Fees</th>
                <th>Net Earnings</th>
              </tr>
            </thead>
            <tbody>
              ${rowsHtml}
            </tbody>
          </table>
        </div>
      `;

      drawer.classList.add("open");
      drawer.setAttribute("aria-hidden","false");
      drawer.scrollTop = 0;
    }

    // --------------------------
    // KPI click wiring
    // (for now they just open simple summary drawers; you can extend)
    // --------------------------
    document.querySelectorAll(".kpi").forEach(k => {
      k.addEventListener("click", () => {
        const key = k.getAttribute("data-kpi");
        if(key === "netToDate"){
          drawerTitle.textContent = "Total Net Earnings to Date";
          drawerSub.textContent = "Portfolio-level earnings across all loans";
          drawerPrimaryTitle.textContent = "Net Earnings to Date";
          drawerPrimary.textContent = `$${kpis.totalNetToDate.toFixed(2)}`;
          drawerSecondaryTitle.textContent = "Total Fees to Date";
          drawerSecondary.textContent = `$${kpis.totalFeesToDate.toFixed(2)}`;
          drawerChartArea.innerHTML = "";
          drawerExtra.innerHTML = `
            <p class="small" style="margin-top:8px;">
              This KPI sums loan-level net earnings (principal + interest âˆ’ fees) at month ${CURRENT_MONTH}.
            </p>
          `;
          drawer.classList.add("open");
          drawer.setAttribute("aria-hidden","false");
        }
        if(key === "projected"){
          drawerTitle.textContent = "Projected Lifetime Earnings";
          drawerSub.textContent = "Net earnings at maturity for all loans.";
          drawerPrimaryTitle.textContent = "Projected Lifetime Net";
          drawerPrimary.textContent = `$${kpis.totalNetProjected.toFixed(2)}`;
          drawerSecondaryTitle.textContent = "Total Principal";
          const totalPrin = loans.reduce((s,l)=>s+l.purchasePrice,0);
          drawerSecondary.textContent = `$${totalPrin.toLocaleString()}`;
          drawerChartArea.innerHTML = "";
          drawerExtra.innerHTML = `
            <p class="small" style="margin-top:8px;">
              Projection uses the full amortization schedule for each loan and cumulative flat monthly fees.
            </p>
          `;
          drawer.classList.add("open");
          drawer.setAttribute("aria-hidden","false");
        }
        if(key === "avgMonthly"){
          drawerTitle.textContent = "Average Monthly Earnings";
          drawerSub.textContent = `Based on net earnings through month ${CURRENT_MONTH}.`;
          drawerPrimaryTitle.textContent = "Avg Monthly Earnings";
          drawerPrimary.textContent = `$${kpis.avgMonthlyEarnings.toFixed(2)}`;
          drawerSecondaryTitle.textContent = "Months Counted";
          drawerSecondary.textContent = `${CURRENT_MONTH} months`;
          drawerChartArea.innerHTML = "";
          drawerExtra.innerHTML = `
            <p class="small" style="margin-top:8px;">
              Calculated as total net earnings to date divided by the current month index.
            </p>
          `;
          drawer.classList.add("open");
          drawer.setAttribute("aria-hidden","false");
        }
        if(key === "fees"){
          drawerTitle.textContent = "Total Fees to Date";
          drawerSub.textContent = "Cumulative monthly fees across all loans.";
          drawerPrimaryTitle.textContent = "Total Fees";
          drawerPrimary.textContent = `$${kpis.totalFeesToDate.toFixed(2)}`;
          drawerSecondaryTitle.textContent = "Total Loans";
          drawerSecondary.textContent = `${loans.length}`;
          drawerChartArea.innerHTML = "";
          let rows = "";
          loansWithEarnings.forEach(l=>{
            const lastIdx = l.earningsSchedule.length-1;
            const atCur = l.earningsSchedule[Math.min(CURRENT_MONTH-1,lastIdx)] || l.earningsSchedule[lastIdx];
            rows += `
              <tr>
                <td>Loan ${l.id}</td>
                <td>${l.purchaseDate}</td>
                <td>$${l.feePerMonth.toFixed(2)}/mo</td>
                <td>$${atCur.cumFees.toFixed(2)}</td>
              </tr>
            `;
          });
          drawerExtra.innerHTML = `
            <div class="amort-wrap">
              <table>
                <thead>
                  <tr>
                    <th>Loan</th>
                    <th>Purchase Date</th>
                    <th>Fee / Month</th>
                    <th>Fees to Date</th>
                  </tr>
                </thead>
                <tbody>${rows}</tbody>
              </table>
            </div>
          `;
          drawer.classList.add("open");
          drawer.setAttribute("aria-hidden","false");
        }
      });
    });

    // --------------------------
    // Theme toggle
    // --------------------------
    const themeToggleBtn = document.getElementById("themeToggle");
    const root = document.documentElement;

    function setTheme(mode){
      root.setAttribute("data-theme", mode);
      if(mode === "dark"){
        themeToggleBtn.textContent = "â˜€ï¸";
      } else {
        themeToggleBtn.textContent = "ðŸŒ™";
      }
      try { localStorage.setItem("earningsTheme", mode); } catch(e){}
    }

    const stored = (()=>{ try { return localStorage.getItem("earningsTheme"); } catch(e){ return null; }})();
    if(stored === "dark" || (!stored && window.matchMedia && window.matchMedia("(prefers-color-scheme: dark)").matches)){
      setTheme("dark");
    } else {
      setTheme("light");
    }

    themeToggleBtn.addEventListener("click", () => {
      const current = root.getAttribute("data-theme") === "dark" ? "dark" : "light";
      setTheme(current === "dark" ? "light" : "dark");
    });
  </script>
</body>
</html>
